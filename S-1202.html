<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor S-1202</title>

  <!-- Tema Cosmo (Bootswatch para Bootstrap 4) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cosmo/bootstrap.min.css"
  />

  <!-- Font Awesome para ícones -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />

  <style>
    /* Barra do topo mais alta e com tom escuro */
    .navbar {
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Pequenos ajustes no título principal */
    h2 {
      margin-top: 1rem;
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    /* Layout geral reorganizado em cards/seções para agrupar melhor as ferramentas */
    .tools-section {
      margin-bottom: 1.5rem;
    }
    .tools-section .card-header {
      font-weight: bold;
      font-size: 1rem;
    }

    /* Espaçamento para grupos de botões */
    .btn-group-custom {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Melhor visual para os cards de Pagamento e subitens */
    .pagamento-card,
    .ideadv-card,
    .period-row,
    .estab-row,
    .remu-row,
    .item-row {
      background-color: #f8f9fa;
    }
    .pagamento-card .card-body,
    .ideadv-card,
    .period-row,
    .estab-row,
    .remu-row,
    .item-row {
      border-radius: 4px;
    }
    .pagamento-card .card-body {
      border: 1px solid #dee2e6;
    }
    .ideadv-card,
    .period-row,
    .estab-row,
    .remu-row,
    .item-row {
      border: 1px solid #dee2e6;
      margin-bottom: 1rem;
      padding: 1rem;
    }
  </style>
</head>
<body>

  <!-- Navbar simples -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Editor Eventos - V1.13</a>
  </nav>

  <!-- Conteúdo principal -->
  <div class="container my-4">
    <h2>Editor S-1202</h2>

    <!-- Seção: Carregar e Baixar -->
    <div class="tools-section card">
      <div class="card-header">Carregar e Baixar Arquivo</div>
      <div class="card-body">
        <div class="form-group">
          <label for="fileInput"><strong>Carregar Arquivo JSON:</strong></label>
          <input type="file" id="fileInput" accept=".json" class="form-control-file" />
        </div>
        <div id="jsonLoadInfo" class="mt-3"></div>
        <button id="downloadBtn" class="btn btn-info">Baixar Edição</button>
      </div>
    </div>

    <!-- Seção: Funções Diversas -->
    <div class="tools-section card">
      <div class="card-header">Funções Principais</div>
      <div class="card-body">
        <div class="btn-group-custom">
          <button id="cpfFilterModalBtn" class="btn btn-primary" data-toggle="modal" data-target="#cpfFilterModal">
            Filtrar / Excluir CPFs
          </button>
          <button id="csvModalBtn" class="btn btn-primary" data-toggle="modal" data-target="#csvModal">
            Analisar Matrículas CSV
          </button>
          <button id="categRemuBtn" class="btn btn-primary">
            Informar Categoria e Estabelecimento
          </button>
          <button id="mergeDmDevModalBtn" class="btn btn-primary" data-toggle="modal" data-target="#mergeDmDevModal">
            Mesclar rubricas por ideDmDev
          </button>
          <button id="ajustarRubricasBtn" class="btn btn-primary">
            Ajustar Pagamentos Negativos
          </button>
          <button id="verificarPeriodosBtn" class="btn btn-primary">
            Verificar RRA
          </button>

          <!-- Funções ocultas / legado -->
          <button id="mergeBtn" style="display:none;" class="btn btn-primary">
            Mesclar por chaveIntegracao
          </button>
          <button type="button" class="btn btn-dark" style="display:none;" data-toggle="modal" data-target="#scriptsModal">
            Substituir Campos
          </button>
        </div>
      </div>
    </div>

    <!-- <!-- Seção: Funções Diversas -->
    <!-- <div class="tools-section card"> -->
      <!-- <div class="card-header">Funções Principais</div> -->
      <!-- <div class="card-body"> -->
        <!-- <div class="btn-group-custom"> -->
          <!-- <button id="mergeBtn" class="btn btn-primary"> -->
            <!-- [1] Mesclar por chaveIntegracao -->
          <!-- </button> -->
			<!-- <button id="estabBtn" class="btn btn-primary" data-toggle="modal" data-target="#estabModal"> -->
			  <!-- [2] Informar Estabelecimentos -->
			<!-- </button> -->
		  <!-- <button id="categRemuBtn" class="btn btn-primary"> -->
			 <!-- [3] Informar Categoria -->
		  <!-- </button> -->
          <!-- <button id="ajustarRubricasBtn" class="btn btn-primary"> -->
            <!-- [4] Ajustar Pagamentos Negativos -->
          <!-- </button> -->
          <!-- <button id="verificarPeriodosBtn" class="btn btn-primary"> -->
            <!-- [5] Verificar Períodos / RRA -->
          <!-- </button> -->
          <!-- <button id="csvModalBtn" class="btn btn-primary" data-toggle="modal" data-target="#csvModal"> -->
            <!-- [6] Analisar Matrículas CSV -->
          <!-- </button> -->
          <!-- <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#scriptsModal"> -->
            <!-- Substituir Campos -->
          <!-- </button> -->
        <!-- </div> -->
      <!-- </div> -->
    <!-- </div> -->
	
	
    <!-- Seção: Seleção em Massa -->
    <div class="tools-section card">
      <div class="card-header">Seleção em Massa</div>
      <div class="card-body">
        <div class="btn-group-custom">
          <button id="selectAllBtn" class="btn btn-primary">Selecionar Todos</button>
          <button id="deselectAllBtn" class="btn btn-secondary">Desmarcar Todos</button>
          <button id="removeSelectedBtn" class="btn btn-danger">Remover Selecionados</button>
        </div>
      </div>
    </div>

    <!-- Campo de busca -->
    <div class="tools-section card">
      <div class="card-header">Filtro de Busca</div>
      <div class="card-body">
        <div class="form-group">
          <label for="searchInput">Buscar (CPF, matrícula, etc.):</label>
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Digite algo para filtrar..."
          />
        </div>
      </div>
    </div>

    <!-- Tabela de Eventos -->
    <div class="tools-section">
      <table class="table table-bordered" id="eventosTable">
        <thead class="thead-light">
          <tr>
            <th style="width:40px;">Seleção</th>
            <th>Ordem Registro</th>
            <th>CPF Trabalhador</th>
            <th>Ano Apuração</th>
            <th>Período Apuração</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal para Carregar CSV -->
    <div class="modal fade" id="csvModal" tabindex="-1" aria-labelledby="csvModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="csvModalLabel">Carregar Arquivo CSV</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="form-group">
              <label for="csvFileInput">Arquivo CSV (cpfTrab;matricula;matricula_atual):</label>
              <input type="file" id="csvFileInput" accept=".csv" class="form-control-file" />
              <small class="form-text text-muted">
                Separador recomendado: <code>;</code>. CPF pode vir com máscara, com 11 dígitos, ou sem zeros à esquerda (será normalizado).
              </small>

              <div class="form-check mt-3">
                <input type="checkbox" class="form-check-input" id="csvHeuristicSuffix">
                <label class="form-check-label" for="csvHeuristicSuffix">
                  Tentar correção automática quando a matrícula terminar em <code>/N</code> ou <code>/NN</code> (ex.: <code>12345/1</code> ou <code>12345/01</code> → <code>12345</code>) caso o CPF não exista no CSV
                </label>
                <small class="form-text text-muted">
                  Opcional e conservador: só remove sufixo final <code>/</code> + 1-2 dígitos, e apenas quando não houver mapeamento por CPF.
                </small>
              </div>

              <div id="csvStatus" class="small text-muted mt-3">Nenhum CSV carregado ainda.</div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="analisarMatriculasBtn">Analisar Matrículas</button>
          </div>
        </div>
      </div>
    </div>

    
    <!-- Modal: Filtrar Trabalhadores por CPF -->
    <div class="modal fade" id="cpfFilterModal" tabindex="-1" role="dialog" aria-labelledby="cpfFilterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cpfFilterModalLabel">Filtrar Trabalhadores (CPF)</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info" style="margin-bottom: 12px;">
              Esta ferramenta remove trabalhadores (eventos <code>s1202RemuTrabRPPS</code>) com base em uma lista de CPFs.
              O CPF é normalizado (somente dígitos) e sempre tratado com 11 dígitos — zeros à esquerda são ignorados/ajustados automaticamente.
            </div>

            <div class="form-group">
              <label><strong>Modo de operação</strong></label>
              <div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="cpfFilterKeep" name="cpfFilterMode" class="custom-control-input" value="keep" checked>
                  <label class="custom-control-label" for="cpfFilterKeep">Manter somente os CPFs informados (remover todos os demais)</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="cpfFilterExclude" name="cpfFilterMode" class="custom-control-input" value="exclude">
                  <label class="custom-control-label" for="cpfFilterExclude">Excluir os CPFs informados (manter todos os demais)</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="cpfFilterList"><strong>Lista de CPFs</strong> (um por linha, ou separados por vírgula/;)</label>
              <textarea id="cpfFilterList" class="form-control" rows="9" placeholder="Exemplos:
12345678909
01234567890
123.456.789-09"></textarea>
              <small class="form-text text-muted">
                Dica: você pode colar colunas inteiras do Excel. O sistema extrai automaticamente sequências numéricas e normaliza para 11 dígitos.
              </small>
            </div>

            <div id="cpfFilterStatus" class="small text-muted"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" id="applyCpfFilterBtn" class="btn btn-danger">Aplicar filtro</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal: Mesclar rubricas por ideDmDev -->
    <div class="modal fade" id="mergeDmDevModal" tabindex="-1" role="dialog" aria-labelledby="mergeDmDevModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="mergeDmDevModalLabel">Mesclar rubricas por ideDmDev</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-2">
              Esta ferramenta consolida pagamentos/demonstrativos dentro de cada trabalhador.
              Ela (i) mescla pagamentos com <strong>ideDmDev idêntico</strong> (união de rubricas), e (ii) remove pagamentos
              <strong>equivalentes</strong> que diferem apenas no ideDmDev (sem perder rubricas).
            </p>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="mergeDmDevAlsoEquivalent" checked>
              <label class="form-check-label" for="mergeDmDevAlsoEquivalent">
                Também remover duplicados equivalentes (difere apenas ideDmDev)
              </label>
            </div>

            <div class="alert alert-info" id="mergeDmDevPreviewAlert" style="display:none;"></div>

            <div class="form-group">
              <label for="mergeDmDevPreview" class="font-weight-bold">Resumo</label>
              <textarea id="mergeDmDevPreview" class="form-control" rows="12" readonly></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" id="refreshMergeDmDevPreviewBtn">Atualizar resumo</button>
            <button type="button" class="btn btn-primary" id="applyMergeDmDevBtn">Aplicar mesclagem</button>
          </div>
        </div>
      </div>
    </div>

<!-- Modal de Edição de Evento -->
    <div
      class="modal fade"
      id="eventoModal"
      tabindex="-1"
      aria-labelledby="eventoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl" style="max-width: 90%;">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="eventoModalLabel">Editar Evento</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Fechar"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="eventoForm">
              <!-- Dados do Evento (campos do topo) -->
              <div class="form-row">
                <div class="form-group col-md-3">
                  <label>Ordem Registro</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control has-placeholder"
                      id="ordemRegistro"
                    />
                  </div>
                </div>
                <div class="form-group col-md-6">
                  <label>Chave Integração</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="chaveIntegracao" />
                  </div>
                </div>
                <div class="form-group col-md-3">
                  <label>Ano Apur</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control has-placeholder"
                      id="anoApur"
                    />
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label>Ind Apuração</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="indApuracao" />
                  </div>
                </div>
                <div class="form-group col-md-4">
                  <label>Possui Período Anterior?</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="indPossuiPerAnt" />
                  </div>
                </div>
                <div class="form-group col-md-4">
                  <label>Período Apuração</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control has-placeholder"
                      id="perApur"
                    />
                  </div>
                </div>
              </div>

              <!-- Empregador -->
              <h5>Empregador</h5>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Nr Insc</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="empregador_nrInsc"
                    />
                  </div>
                </div>
                <div class="form-group col-md-6">
                  <label>Tipo Insc</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="empregador_tpInsc_tipo"
                    />
                  </div>
                </div>
              </div>

              <!-- Trabalhador -->
              <h5>Trabalhador</h5>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>CPF</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="trabalhador_cpfTrab" />
                  </div>
                </div>
                <div class="form-group col-md-6">
                  <label>Nome Complementar</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="nmTrabComplem" />
                  </div>
                </div>
              </div>

              <!-- Pagamentos -->
              <h5>Pagamentos</h5>
              <div id="pagamentosContainer"></div>
              <button
                type="button"
                class="btn btn-outline-primary mb-3"
                id="addPagamentoBtn"
              >
                Adicionar Pagamento
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="saveEventoBtn">
              Salvar Alterações do Evento
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Scripts (Substituições) -->
    <div
      class="modal fade"
      id="scriptsModal"
      tabindex="-1"
      aria-labelledby="scriptsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="scriptsModalLabel">Substituir Campos</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Fechar"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Escolha em qual seção do JSON deseja substituir um determinado campo e valor.</p>
            <div class="form-group">
              <label>Seção do Arquivo</label>
              <select class="form-control" id="scriptScope">
                <option value="evento">Evento (campos básicos do topo)</option>
                <option value="pagto">Pagamentos</option>
                <option value="periodo">Períodos</option>
                <option value="estab">Estabelecimentos</option>
                <option value="remu">Remunerações</option>
                <option value="item">Itens (Rubricas)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Nome do Campo</label>
              <input
                type="text"
                class="form-control"
                id="scriptField"
                placeholder="Ex: anoApur, ideDmDev, qtdMesesRRA, codRubr..."
              />
            </div>
            <div class="form-group">
              <label>Valor Antigo (opcional)</label>
              <input
                type="text"
                class="form-control"
                id="scriptOldValue"
                placeholder="Ex: *vazio*"
              />
            </div>
            <div class="form-group">
              <label>Novo Valor</label>
              <input
                type="text"
                class="form-control"
                id="scriptNewValue"
                placeholder="Ex: 2023-01-01 ou *vazio*"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="applyScriptBtn">
              Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Verificar Períodos e configurar RRA -->
    <div
      class="modal fade"
      id="verificarModal"
      tabindex="-1"
      aria-labelledby="verificarModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verificarModalLabel">Verificar Períodos / RRA</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Fechar"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Configurações para RRA -->
            <div class="form-group">
              <label>Texto para descRRA (sugestão: "Diferencas processadas apos encerramento da folha")</label>
              <input type="text" class="form-control" id="verifDescRRA" value="Diferencas processadas apos encerramento da folha">
            </div>
            <div class="form-group">
              <label>Tipo Processo RRA (sugestão: 1)</label>
              <input type="text" class="form-control" id="verifTpProcRRA" value="1">
            </div>

            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="verifRRA032023">
              <label class="form-check-label" for="verifRRA032023">
                Aplicar “Opção RRA 03/2023” (não informar RRA nos pagamentos)
              </label>
            </div>

            <hr>
            <p>
              <strong>Regras:</strong><br>
              1) "Possui Período Anterior?" = "S" se qualquer 'Per Ref' for mês anterior ao 'Período Apuração' (comparação ano/mês). Senão "N".<br>
              2) Para RRA, comparar apenas o <strong>ano</strong>: se perRef tiver ano < ano do perApur => indRRA="S", senão "*vazio*".<br>
              3) Ajusta “descRRA”, “qtdMesesRRA”, “tpProcRRA” se “indRRA=S”.<br>
              4) Ajusta “indApurIR” = "0".<br>
              5) Se “RRA 03/2023” estiver ativo, ignora as demais regras e zera (indRRA, qtdMesesRRA, tpProcRRA, descRRA).
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="applyVerificarBtn">
              Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Informar Estabelecimentos -->
    <div
      class="modal fade"
      id="estabModal"
      tabindex="-1"
      aria-labelledby="estabModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="estabModalLabel">Informar Estabelecimentos</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Fechar"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Configurações para Estabelecimento -->
            <div class="form-group">
              <label>iniValid (sugestão: 2021-07-01)</label>
              <input type="text" class="form-control" id="estabIniValid" value="2021-07-01">
            </div>
            <div class="form-group">
              <label>nrInsc (sugestão: 11239018000167)</label>
              <input type="text" class="form-control" id="estabNrInsc" value="11239018000167">
            </div>
            <div class="form-group">
              <label>tpInsc (sugestão: 1)</label>
              <input type="text" class="form-control" id="estabTpInsc" value="1">
            </div>
            <p>
              Ao clicar em “Aplicar”, por padrão serão preenchidos apenas os estabelecimentos vazios/placeholder com os valores informados.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="applyEstabBtn">
              Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

		<!-- Modal: Informar Categoria e Estabelecimento -->
<div class="modal fade" id="categRemuModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Informar Categoria e Estabelecimento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info small mb-3">
          Esta ferramenta preenche <strong>somente placeholders/vazios</strong> por padrão, para reduzir impactos e preservar integridade/auditoria.
          Você pode habilitar sobrescrita explicitamente.
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header"><strong>Categoria</strong></div>
              <div class="card-body">
                <div class="form-group mb-2">
                  <label class="mb-1">codCateg (numérico)</label>
                  <input type="text" id="categRemuValue" value="301" class="form-control" placeholder="Ex: 301">
                  <small class="text-muted">Aplicado em <code>remu.contrato.codCateg.categoria</code> quando estiver <code>*numerovazio*</code>.</small>
                </div>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="applyCategoriaChk" checked>
                  <label class="custom-control-label" for="applyCategoriaChk">Aplicar categoria nos placeholders</label>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header"><strong>Estabelecimento</strong></div>
              <div class="card-body">
                <div class="form-group mb-2">
                  <label class="mb-1">iniValid (YYYY-MM-DD)</label>
                  <input type="text" class="form-control" id="categEstabIniValid" value="2021-07-01" placeholder="Ex: 2021-07-01">
                </div>
                <div class="form-group mb-2">
                  <label class="mb-1">nrInsc (CNPJ – 14 dígitos)</label>
                  <input type="text" class="form-control" id="categEstabNrInsc" value="11239018000167" placeholder="Ex: 11239018000167">
                </div>
                <div class="form-group mb-2">
                  <label class="mb-1">tpInsc (sugestão: 1 = CNPJ)</label>
                  <input type="text" class="form-control" id="categEstabTpInsc" value="1" placeholder="Ex: 1">
                </div>

                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="applyEstabChk" checked>
                  <label class="custom-control-label" for="applyEstabChk">Preencher estabelecimentos vazios</label>
                </div>
                <div class="custom-control custom-checkbox mt-1">
                  <input type="checkbox" class="custom-control-input" id="overwriteEstabChk">
                  <label class="custom-control-label" for="overwriteEstabChk">Sobrescrever estabelecimentos já preenchidos</label>
                </div>
                <small class="text-muted d-block mt-2">
                  Por padrão, o editor só preenche quando <code>nrInsc</code> está ausente/vazio (ou placeholder). Se habilitar sobrescrita, todos serão atualizados.
                </small>
              </div>
            </div>
          </div>
        </div>

        <div class="border rounded p-2 small bg-light" id="categEstabPreview">
          Carregue um arquivo para ver o resumo aqui.
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        <button id="applyCategRemuBtn" class="btn btn-primary">Aplicar</button>
      </div>
    </div>
  </div>
</div>



  

<!-- Modal: Ajustar Pagamentos Negativos (prévia + confirmação) -->
<div class="modal fade" id="negativosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajustar Pagamentos Negativos</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="alert alert-warning small">
          <strong>O que esta rotina faz:</strong> para cada demonstrativo (<code>ideDmDev</code>), calcula o saldo
          <code>VANT - DESC</code> somando as rubricas. Se o saldo for <strong>negativo</strong>, o editor adiciona uma rubrica
          <code>998V</code> (VANT) com o valor exato para zerar o saldo, no <strong>último período</strong> (<code>perRef</code>)
          do demonstrativo. A rotina não altera rubricas existentes.
        </div>

        <div class="custom-control custom-checkbox mb-2">
          <input type="checkbox" class="custom-control-input" id="negSkipIfExistsChk" checked>
          <label class="custom-control-label" for="negSkipIfExistsChk">Não adicionar se já existir rubrica 998V no mesmo perRef</label>
        </div>

        <div class="border rounded p-2 bg-light small mb-3" id="negativosPreview">
          Carregue um arquivo para visualizar a prévia.
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0">
            <thead class="thead-light">
              <tr>
                <th>CPF</th>
                <th>ideDmDev</th>
                <th>perRef (alvo)</th>
                <th class="text-right">Saldo</th>
                <th class="text-right">Ajuste (998V)</th>
              </tr>
            </thead>
            <tbody id="negativosTableBody">
              <tr><td colspan="5" class="text-muted">—</td></tr>
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Observação: por auditoria, o editor apenas adiciona o item necessário; campos estruturais (ex.: <code>DescFolha</code>) são mantidos no padrão do arquivo.
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        <button id="applyNegativosBtn" class="btn btn-primary">Aplicar ajuste</button>
      </div>
    </div>
  </div>
</div>

</div><!-- container -->

  <!-- JS (jQuery, Popper, Bootstrap) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
  ></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
  ></script>

  <!-- Script principal (toda a lógica do editor) -->
  <script>
    // ======================================================================
    // 1) Definir dados iniciais
    window.esocialData = {
      "s1202RemuTrabRPPSGroup": {
        "s1202RemuTrabRPPS": []
      }
    };

    

    // ======================================================================
    // Controle de arquivo carregado (para salvar com o mesmo nome + "_editado")
    let loadedFileName = null;
    let loadedFileMeta = null;

    function stripUtf8Bom(text) {
      if (!text) return "";
      const s = String(text);
      return s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
    }

    // Parse de JSON com tolerância mínima (BOM e vírgula sobrando no final de objetos/arrays).
    // Observação: só tenta "reparo" se o JSON padrão falhar.
    function parseJsonSafely(rawText) {
      const t = stripUtf8Bom(rawText);
      try {
        return { data: JSON.parse(t), repaired: false };
      } catch (err1) {
        const repairedText = String(t).replace(/,\s*([}\]])/g, "$1");
        try {
          return { data: JSON.parse(repairedText), repaired: true };
        } catch (err2) {
          throw err1;
        }
      }
    }

    function buildEditedFileName(originalName) {
      if (!originalName) return null;
      const name = String(originalName);
      const dot = name.lastIndexOf(".");
      const base = dot > 0 ? name.slice(0, dot) : name;
      const ext = dot > 0 ? name.slice(dot) : ".json";
      return base + "_editado" + ext;
    }

// ======================================================================
    // 2) ESTRUTURA PARA OBTER EVENTOS
    function getEventos() {
      if (!window.esocialData.s1202RemuTrabRPPSGroup) {
        window.esocialData.s1202RemuTrabRPPSGroup = { s1202RemuTrabRPPS: [] };
      }
      return window.esocialData.s1202RemuTrabRPPSGroup.s1202RemuTrabRPPS;
    }

    // ----------------------------------------------------------------------
    // Converte "YYYY-MM" ou "YYYYMM" em número (ex.: 2023-03 => 202303) p/ comparar mês anterior
    function parseYearMonth(str) {
      if (!str) return 0;
      let clean = str.replace("-", "");
      clean = clean.substring(0,6);
      const num = parseInt(clean, 10);
      return isNaN(num) ? 0 : num;
    }

    // Retorna apenas o ANO de "YYYY-MM"/"YYYYMM"
    function parseYear(str) {
      if (!str) return 0;
      return parseInt(str.substring(0,4), 10) || 0;
    }

    // ----------------------------------------------------------------------
    // FUNÇÃO AUXILIAR: mergeDeep
    function mergeDeep(target, source) {
      for (let key in source) {
        if (source.hasOwnProperty(key)) {
          if (source[key] && typeof source[key] === "object" && !Array.isArray(source[key])) {
            if (!target[key]) target[key] = {};
            mergeDeep(target[key], source[key]);
          } else if (Array.isArray(source[key])) {
            if (source[key].length > 0) {
              target[key] = source[key];
            }
          } else {
            target[key] = source[key];
          }
        }
      }
      return target;
    }


    // ----------------------------------------------------------------------
    // IDEDMDEV VALIDATION (tamanho e correção automática opcional)
    const IDEDMDEV_MAXLEN = 30;

    function suggestIdeDmDevFix(value) {
      const original = (value || "").toString();
      if (!original) return { ok: false, original, suggested: "", reason: "vazio" };
      if (original.length <= IDEDMDEV_MAXLEN) return { ok: true, original, suggested: original, reason: "ok" };

      // 1) Remover pontos (.) — geralmente são apenas formatação de matrícula
      let s1 = original.replace(/\./g, "");
      if (s1.length <= IDEDMDEV_MAXLEN) return { ok: false, original, suggested: s1, reason: "remover_pontos" };

      // 2) Abreviar tipos comuns de demonstrativo/folha
      let s2 = original
        .replace(/SUPLEMENTO/gi, "SUP")
        .replace(/COMPLEMENTO/gi, "COMP")
        .replace(/NORMAL/gi, "NORM")
        .replace(/ADIANTAMENTO/gi, "ADI");
      // repetir sem pontos, porque costuma ajudar
      s2 = s2.replace(/\./g, "");
      if (s2.length <= IDEDMDEV_MAXLEN) return { ok: false, original, suggested: s2, reason: "abreviar_tipo" };

      // 3) Último recurso: truncar preservando o final (tipo + competência) para manter leitura
      // Ex.: manter os últimos 14 caracteres por padrão (inclui "-122024"), e ajustar o início.
      const keepTail = Math.min(14, s2.length);
      const tail = s2.slice(-keepTail);
      const headMax = IDEDMDEV_MAXLEN - tail.length;
      const s3 = (headMax > 0 ? s2.slice(0, headMax) : "") + tail;
      return { ok: false, original, suggested: s3, reason: "truncar" };
    }

    function validateIdeDmDevInEvento(evt) {
      const problemas = [];
      const pagtos = evt?.s1202RemuTrabRPPSPagtos || [];
      pagtos.forEach((p, idx) => {
        const ide = (p?.ideDmDev || "").toString();
        if (!ide) {
          problemas.push({ idx, ide, issue: "vazio", fix: "" });
          return;
        }
        if (ide.length > IDEDMDEV_MAXLEN) {
          const sug = suggestIdeDmDevFix(ide);
          problemas.push({ idx, ide, issue: `maior_que_${IDEDMDEV_MAXLEN}`, fix: sug.suggested, reason: sug.reason });
        }
      });
      return problemas;
    }

    function applyIdeDmDevAutoFix(evt, problemas) {
      if (!Array.isArray(problemas) || problemas.length === 0) return;
      const pagtos = evt?.s1202RemuTrabRPPSPagtos || [];
      problemas.forEach((p) => {
        if (typeof p.idx !== "number") return;
        if (p.fix && pagtos[p.idx]) pagtos[p.idx].ideDmDev = p.fix;
      });
    }
    // ----------------------------------------------------------------------
    // PLACEHOLDER CONFIG
    const placeholdersMap = {
      "cnpjOrgaoAntComplem": ["*vazio*"],
      "dtExercicioComplem": ["*datavazia*"],
      "dtNasctoComplem": ["*datavazia*"],
      "matricAntComplem": ["*vazio*"],
      "observacaoComplem": ["*vazio*"],
      "descRRA": ["*vazio*"],
      "indRRA": ["*vazio*"],  // Ajustado: não tem 'N'
      "nrProcRRA": ["*vazio*"],
      "qtdMesesRRA": ["*numerovazio*"],
      "tpProcRRA": ["*vazio*"],
      "vlrDespAdvogados": ["*numerovazio*"],
      "vlrDespCustas": ["*numerovazio*"],
      "contratoTSV": ["*vazio*"],
      "dtAdm": ["*datavazia*"],
      "codCateg": ["*numerovazio*"],
      "fatorRubr": ["*numerovazio*"],
      "codRubr": ["*numerovazio*"],
      "iniValid": ["*datavazia*"]
    };

    // ----------------------------------------------------------------------
    // Pegar valor de input com segurança
    function safeValue(parent, selector) {
      const el = parent.querySelector(selector);
      return el ? el.value.trim() : "";
    }

    // ----------------------------------------------------------------------
    // 3) TABELA DE EVENTOS
    function renderEventosTable() {
      const tbody = document.querySelector("#eventosTable tbody");
      tbody.innerHTML = "";
      const eventos = getEventos();
      const searchValue = (document.getElementById("searchInput").value || "").toLowerCase();

      eventos.forEach((evt, index) => {
        if (typeof evt._selected === "undefined") {
          evt._selected = false;
        }
        // Filtragem
        const combinedText = JSON.stringify(evt).toLowerCase();
        if (!searchValue || combinedText.includes(searchValue)) {
          const tr = document.createElement("tr");

          // Seleção
          const tdCheck = document.createElement("td");
          tdCheck.style.textAlign = "center";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = !!evt._selected;
          checkbox.addEventListener("change", () => {
            evt._selected = checkbox.checked;
          });
          tdCheck.appendChild(checkbox);
          tr.appendChild(tdCheck);

          // Ordem Registro
          const tdOrdem = document.createElement("td");
          tdOrdem.textContent = evt.ordemRegistro || "";
          tr.appendChild(tdOrdem);

          // CPF
          const tdCpf = document.createElement("td");
          tdCpf.textContent = evt.trabalhador?.cpfTrab || "";
          tr.appendChild(tdCpf);

          // Ano
          const tdAno = document.createElement("td");
          tdAno.textContent = evt.anoApur || "";
          tr.appendChild(tdAno);

          // Período
          const tdPerApur = document.createElement("td");
          tdPerApur.textContent = evt.perApur || "";
          tr.appendChild(tdPerApur);

          // Ações
          const tdAcoes = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.className = "btn btn-sm btn-warning mr-2";
          btnEdit.textContent = "Editar";
          btnEdit.addEventListener("click", () => openEventoModal(index));
          tdAcoes.appendChild(btnEdit);

          const btnRemove = document.createElement("button");
          btnRemove.className = "btn btn-sm btn-danger";
          btnRemove.textContent = "Remover";
          btnRemove.addEventListener("click", () => {
            if (confirm("Deseja remover este evento?")) {
              getEventos().splice(index, 1);
              renderEventosTable();
            }
          });
          tdAcoes.appendChild(btnRemove);

          tr.appendChild(tdAcoes);
          tbody.appendChild(tr);
        }
      });
    }
    document.getElementById("searchInput").addEventListener("input", renderEventosTable);

    // ----------------------------------------------------------------------
    // 4) MODAL DE EDIÇÃO
    let currentEditingEventIndex = null;
    let currentEditingEventOriginal = null;

    function openEventoModal(index) {
      const isNew = index === null || index === undefined;
      const baseEvento = {
        ordemRegistro: "",
        chaveIntegracao: "",
        anoApur: "",
        cnpjOrgaoAntComplem: "*vazio*",
        dtExercicioComplem: "*datavazia*",
        dtNasctoComplem: "*datavazia*",
        empregador: { nrInsc: "", tpInsc: { tipo: "" } },
        indApuracao: "",
        indPossuiPerAnt: "",
        matricAntComplem: "*vazio*",
        nmTrabComplem: "*vazio*",
        observacaoComplem: "*vazio*",
        perApur: "",
        trabalhador: { cpfTrab: "" },
        s1202RemuTrabRPPSPagtos: []
      };

      let evt;
      if (isNew) {
        evt = JSON.parse(JSON.stringify(baseEvento));
      } else {
        evt = JSON.parse(JSON.stringify(getEventos()[index]));
      }

      currentEditingEventIndex = isNew ? null : index;
      currentEditingEventOriginal = evt;

      // Preenche campos
      document.getElementById("ordemRegistro").value = evt.ordemRegistro || "";
      document.getElementById("chaveIntegracao").value = evt.chaveIntegracao || "";
      document.getElementById("anoApur").value = evt.anoApur || "";
      document.getElementById("indApuracao").value = evt.indApuracao || "";
      document.getElementById("indPossuiPerAnt").value = evt.indPossuiPerAnt || "";
      document.getElementById("perApur").value = evt.perApur || "";
      document.getElementById("empregador_nrInsc").value = evt.empregador.nrInsc || "";
      document.getElementById("empregador_tpInsc_tipo").value = evt.empregador.tpInsc.tipo || "";
      document.getElementById("trabalhador_cpfTrab").value = evt.trabalhador.cpfTrab || "";
      document.getElementById("nmTrabComplem").value = evt.nmTrabComplem || "";

      // Renderiza pagamentos
      const pagamentosContainer = document.getElementById("pagamentosContainer");
      pagamentosContainer.innerHTML = "";
      evt.s1202RemuTrabRPPSPagtos.forEach((p) => addPagamentoCard(pagamentosContainer, p));

      document.getElementById("addPagamentoBtn").onclick = () => {
        const newPagto = {
          codCateg: { categoria: "" },
          descRRA: "",
          ideDmDev: "",
          indRRA: "",
          nrProcRRA: "",
          qtdMesesRRA: "",
          remunOrgSuc: "",
          tpProcRRA: "",
          vlrDespAdvogados: "",
          vlrDespCustas: "",
          s1202RemuTrabRPPSIdeAdv: [],
          s1202RemuTrabRPPSPer: []
        };
        if (!currentEditingEventOriginal.s1202RemuTrabRPPSPagtos) {
          currentEditingEventOriginal.s1202RemuTrabRPPSPagtos = [];
        }
        currentEditingEventOriginal.s1202RemuTrabRPPSPagtos.push(newPagto);
        addPagamentoCard(pagamentosContainer, newPagto);
      };

      addPlaceholderDropdowns();
      $("#eventoModal").modal("show");
    }

    // ----------------------------------------------------------------------
    // 5) PLACEHOLDER DROPDOWNS
    function addPlaceholderDropdowns() {
      const allInputs = document.querySelectorAll("#eventoModal input.has-placeholder");
      allInputs.forEach((input) => {
        const fieldName = input.id || "";
        let pureField = fieldName.includes("_") ? fieldName.split("_").slice(-1)[0] : fieldName;
        const placeholders = placeholdersMap[pureField];
        if (!placeholders) return;
        if (input.parentElement.querySelector(".placeholder-select")) return;
        const select = document.createElement("select");
        select.className = "form-control placeholder-select";
        select.style.minWidth = "100px";
        select.setAttribute("data-field", "#" + fieldName);
        const optDefault = document.createElement("option");
        optDefault.value = "";
        optDefault.textContent = "(Digite valor)";
        select.appendChild(optDefault);
        placeholders.forEach((ph) => {
          const opt = document.createElement("option");
          opt.value = ph;
          opt.textContent = ph;
          select.appendChild(opt);
        });
        let wrapper = input.parentElement;
        if (!wrapper.classList.contains("input-group")) return;
        let appendDiv = wrapper.querySelector(".input-group-append");
        if (!appendDiv) {
          appendDiv = document.createElement("div");
          appendDiv.className = "input-group-append";
          wrapper.appendChild(appendDiv);
        }
        appendDiv.appendChild(select);
      });
    }

    // ----------------------------------------------------------------------
    // FUNÇÕES PARA OBTER DADOS DE SUBNÍVEIS (IdeAdv, Períodos, etc.)
    function getIdeAdvFromCard(card) {
      const container = card.querySelector(".ideadv-container");
      if (!container) return null;
      const ideAdvCards = container.querySelectorAll(".ideadv-card");
      if (ideAdvCards.length === 0) return null;

      let arr = [];
      ideAdvCards.forEach((card) => {
        const originalIde = parseJsonSafely(card.dataset.original || "{}").data || {};
        const updatedIde = {
          nrInsc: safeValue(card, ".ideadv-nrInsc"),
          tpInsc: { tipo: safeValue(card, ".ideadv-tpInsc") },
          vlrAdv: safeValue(card, ".ideadv-vlrAdv")
        };

        arr.push(mergeDeep(originalIde, updatedIde));
      });

      return arr;
    }

    function getPeriodsFromCard(card) {
      const periodRows = card.querySelectorAll(".period-row");
      if (periodRows.length === 0) return null;

      let periods = [];
      periodRows.forEach((row) => {
        const originalPeriod = parseJsonSafely(row.dataset.original || "{}").data || {};
        const updatedPeriod = {
          anoRef: safeValue(row, ".period-anoRef"),
          perRef: safeValue(row, ".period-perRef"),
          tpRegistro: safeValue(row, ".period-tpRegistro"),
          s1202RemuTrabRPPSEstab: getEstabsFromPeriodRow(row)
        };

        periods.push(mergeDeep(originalPeriod, updatedPeriod));
      });

      return periods;
    }

    function getEstabsFromPeriodRow(row) {
      const container = row.querySelector(".estabs-container");
      const estabRows = container ? container.querySelectorAll(".estab-row") : [];
      if (estabRows.length === 0) return null;

      let estabs = [];
      estabRows.forEach((estRow) => {
        const originalEstab = parseJsonSafely(estRow.dataset.original || "{}").data || {};
        const updatedEstab = {
          nrInsc: {
            iniValid: safeValue(estRow, ".estab-iniValid"),
            nrInsc: safeValue(estRow, ".estab-nrInsc"),
            tpInsc: { tipo: safeValue(estRow, ".estab-tpInsc") }
          },
          s1202RemuTrabRPPSRemu: getRemusFromEstabRow(estRow)
        };

        estabs.push(mergeDeep(originalEstab, updatedEstab));
      });

      return estabs;
    }

    function getRemusFromEstabRow(estRow) {
      const container = estRow.querySelector(".remu-container");
      const remuRows = container ? container.querySelectorAll(".remu-row") : [];
      if (remuRows.length === 0) return null;

      let remus = [];
      remuRows.forEach((remRow) => {
        const originalRemu = parseJsonSafely(remRow.dataset.original || "{}").data || {};
        const updatedRemu = {
          contrato: {
            codCateg: { categoria: safeValue(remRow, ".remu-codCateg") },
            contratoTSV: safeValue(remRow, ".remu-contratoTSV"),
            dtAdm: safeValue(remRow, ".remu-dtAdm"),
            matricula: safeValue(remRow, ".remu-matricula")
          },
          s1202RemuTrabRPPSItens: getItemsFromRemuRow(remRow)
        };

        // Preservar campos fora do modal (ou campos opcionais do layout) mantendo o objeto original.
        remus.push(mergeDeep(originalRemu, updatedRemu));
      });

      return remus;
    }

    function getItemsFromRemuRow(remRow) {
      const container = remRow.querySelector(".itens-container");
      const itemRows = container ? container.querySelectorAll(".item-row") : [];
      if (itemRows.length === 0) return null;

      let items = [];
      itemRows.forEach((itemRow) => {
        const originalItem = parseJsonSafely(itemRow.dataset.original || "{}").data || {};
        const updatedItem = {
          codRubr: {
            codRubr: safeValue(itemRow, ".item-codRubr"),
            iniValid: safeValue(itemRow, ".item-iniValid")
          },
          fatorRubr: safeValue(itemRow, ".item-fatorRubr"),
          ideTabRubr: safeValue(itemRow, ".item-ideTabRubr"),
          indApurIR: safeValue(itemRow, ".item-indApurIR"),
          qtdRubr: safeValue(itemRow, ".item-qtdRubr"),
          vrRubr: safeValue(itemRow, ".item-vrRubr")
        };

        // Importante: não reconstruir o objeto do item do zero.
        // Fazemos merge em cima do original para preservar campos não expostos no UI (ex.: s1202RemuTrabRPPSDescFolha)
        // e evitar perda de informações exigidas pelo validador/eSocial.
        items.push(mergeDeep(originalItem, updatedItem));
      });

      return items;
    }

    // ----------------------------------------------------------------------
    // 6) ADIÇÃO DE CARTÕES (Pagamentos, IdeAdv, Períodos etc.)
    function addPagamentoCard(container, pagto) {
      const card = document.createElement("div");
      card.className = "card mb-3 pagamento-card";
      card.dataset.original = JSON.stringify(pagto);
      card.innerHTML = `
        <div class="card-body">
          <h6>Pagamento</h6>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Categoria</label>
              <input type="text" class="form-control pagto-categoria has-placeholder" value="${pagto.codCateg.categoria || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>ideDmDev</label>
              <input type="text" class="form-control pagto-ideDmDev" value="${pagto.ideDmDev || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>indRRA</label>
              <input type="text" class="form-control pagto-indRRA has-placeholder" value="${pagto.indRRA || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>descRRA</label>
              <input type="text" class="form-control pagto-descRRA has-placeholder" value="${pagto.descRRA || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>nrProcRRA</label>
              <input type="text" class="form-control pagto-nrProcRRA" value="${pagto.nrProcRRA || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>qtdMesesRRA</label>
              <input type="text" class="form-control pagto-qtdMesesRRA has-placeholder" value="${pagto.qtdMesesRRA || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>remunOrgSuc</label>
              <input type="text" class="form-control pagto-remunOrgSuc" value="${pagto.remunOrgSuc || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>tpProcRRA</label>
              <input type="text" class="form-control pagto-tpProcRRA has-placeholder" value="${pagto.tpProcRRA || ''}">
            </div>
            <div class="form-group col-md-4">
              <label>vlrDespAdvogados</label>
              <input type="text" class="form-control pagto-vlrDespAdvogados has-placeholder" value="${pagto.vlrDespAdvogados || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>vlrDespCustas</label>
              <input type="text" class="form-control pagto-vlrDespCustas has-placeholder" value="${pagto.vlrDespCustas || ''}">
            </div>
            <div class="form-group col-md-4 d-flex align-items-end">
              <button type="button" class="btn btn-outline-danger remove-pagto-btn">Remover Pagamento</button>
            </div>
          </div>
          <!-- IdeAdv -->
          <h6>IdeAdv</h6>
          <div class="ideadv-container"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary add-ideadv-btn">Adicionar IdeAdv</button>
          <hr>
          <!-- Períodos -->
          <h6>Períodos</h6>
          <div class="periods-container"></div>
          <button type="button" class="btn btn-sm btn-outline-primary add-period-btn">Adicionar Período</button>
        </div>
      `;
      container.appendChild(card);

      card.querySelector(".remove-pagto-btn").onclick = () => {
        if (confirm("Remover este pagamento?")) {
          card.remove();
        }
      };

      // IdeAdv
      const ideadvContainer = card.querySelector(".ideadv-container");
      if (pagto.s1202RemuTrabRPPSIdeAdv && pagto.s1202RemuTrabRPPSIdeAdv.length) {
        pagto.s1202RemuTrabRPPSIdeAdv.forEach((ideadv) => addIdeAdvCard(ideadvContainer, ideadv));
      }
      card.querySelector(".add-ideadv-btn").onclick = () => {
        const newIdeAdv = {
          nrInsc: "*vazio*",
          tpInsc: { tipo: "*numerovazio*" },
          vlrAdv: "*numerovazio*"
        };
        if (!pagto.s1202RemuTrabRPPSIdeAdv) {
          pagto.s1202RemuTrabRPPSIdeAdv = [];
        }
        pagto.s1202RemuTrabRPPSIdeAdv.push(newIdeAdv);
        addIdeAdvCard(ideadvContainer, newIdeAdv);
      };

      // Períodos
      const periodsContainer = card.querySelector(".periods-container");
      if (pagto.s1202RemuTrabRPPSPer && pagto.s1202RemuTrabRPPSPer.length) {
        pagto.s1202RemuTrabRPPSPer.forEach((per) => addPeriodRow(periodsContainer, per));
      }
      card.querySelector(".add-period-btn").onclick = () => {
        const newPeriod = {
          anoRef: "",
          perRef: "",
          tpRegistro: "",
          s1202RemuTrabRPPSEstab: []
        };
        if (!pagto.s1202RemuTrabRPPSPer) {
          pagto.s1202RemuTrabRPPSPer = [];
        }
        pagto.s1202RemuTrabRPPSPer.push(newPeriod);
        addPeriodRow(periodsContainer, newPeriod);
      };

      addPlaceholderDropdowns();
    }

    function addIdeAdvCard(container, ideadv) {
      const card = document.createElement("div");
      card.className = "card mb-2 ideadv-card p-2";
      card.dataset.original = JSON.stringify(ideadv);
      card.innerHTML = `
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>nrInsc</label>
            <input type="text" class="form-control ideadv-nrInsc has-placeholder" value="${ideadv.nrInsc || ''}">
          </div>
          <div class="form-group col-md-4">
            <label>tpInsc</label>
            <input type="text" class="form-control ideadv-tpInsc has-placeholder" value="${ideadv.tpInsc.tipo || ''}">
          </div>
          <div class="form-group col-md-4">
            <label>vlrAdv</label>
            <input type="text" class="form-control ideadv-vlrAdv has-placeholder" value="${ideadv.vlrAdv || ''}">
          </div>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm remove-ideadv-btn">Remover IdeAdv</button>
      `;
      container.appendChild(card);
      card.querySelector(".remove-ideadv-btn").onclick = () => {
        if (confirm("Remover este IdeAdv?")) {
          card.remove();
        }
      };
      addPlaceholderDropdowns();
    }

    function addPeriodRow(container, period) {
      const row = document.createElement("div");
      row.className = "border p-2 mb-2 period-row";
      row.dataset.original = JSON.stringify(period || {});

      row.innerHTML = `
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Ano Ref</label>
            <input type="text" class="form-control period-anoRef has-placeholder" value="${period.anoRef || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>Per Ref</label>
            <input type="text" class="form-control period-perRef has-placeholder" value="${period.perRef || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>tpRegistro</label>
            <input type="text" class="form-control period-tpRegistro has-placeholder" value="${period.tpRegistro || ''}">
          </div>
          <div class="form-group col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger remove-period-btn">Remover Período</button>
          </div>
        </div>
        <h6>Estabelecimentos</h6>
        <div class="estabs-container"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary add-estab-btn">Adicionar Estabelecimento</button>
      `;
      container.appendChild(row);
      row.querySelector(".remove-period-btn").onclick = () => {
        row.remove();
      };

      const estabsContainer = row.querySelector(".estabs-container");
      if (period.s1202RemuTrabRPPSEstab && period.s1202RemuTrabRPPSEstab.length) {
        period.s1202RemuTrabRPPSEstab.forEach((est) => addEstabRow(estabsContainer, est));
      }
      row.querySelector(".add-estab-btn").onclick = () => {
        const newEstab = {
          nrInsc: { iniValid: "", nrInsc: "", tpInsc: { tipo: "" } },
          s1202RemuTrabRPPSRemu: []
        };
        if (!period.s1202RemuTrabRPPSEstab) {
          period.s1202RemuTrabRPPSEstab = [];
        }
        period.s1202RemuTrabRPPSEstab.push(newEstab);
        addEstabRow(estabsContainer, newEstab);
      };

      addPlaceholderDropdowns();
    }

    function addEstabRow(container, estab) {
      const row = document.createElement("div");
      row.className = "border p-2 mb-2 estab-row";
      row.dataset.original = JSON.stringify(estab || {});

      row.innerHTML = `
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>iniValid</label>
            <input type="text" class="form-control estab-iniValid has-placeholder" value="${estab.nrInsc.iniValid || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>nrInsc</label>
            <input type="text" class="form-control estab-nrInsc has-placeholder" value="${estab.nrInsc.nrInsc || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>tpInsc</label>
            <input type="text" class="form-control estab-tpInsc has-placeholder" value="${estab.nrInsc.tpInsc.tipo || ''}">
          </div>
          <div class="form-group col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger remove-estab-btn">Remover Estabelecimento</button>
          </div>
        </div>
        <h6>Remunerações</h6>
        <div class="remu-container"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary add-remu-btn">Adicionar Remuneração</button>
      `;
      container.appendChild(row);
      row.querySelector(".remove-estab-btn").onclick = () => {
        row.remove();
      };

      const remuContainer = row.querySelector(".remu-container");
      if (estab.s1202RemuTrabRPPSRemu && estab.s1202RemuTrabRPPSRemu.length) {
        estab.s1202RemuTrabRPPSRemu.forEach((r) => addRemuRow(remuContainer, r));
      }
      row.querySelector(".add-remu-btn").onclick = () => {
        const newRemu = {
          contrato: {
            codCateg: { categoria: "" },
            contratoTSV: "",
            dtAdm: "",
            matricula: ""
          },
          s1202RemuTrabRPPSItens: []
        };
        if (!estab.s1202RemuTrabRPPSRemu) {
          estab.s1202RemuTrabRPPSRemu = [];
        }
        estab.s1202RemuTrabRPPSRemu.push(newRemu);
        addRemuRow(remuContainer, newRemu);
      };

      addPlaceholderDropdowns();
    }

    function addRemuRow(container, remu) {
      const row = document.createElement("div");
      row.className = "border p-2 mb-2 remu-row";
      row.dataset.original = JSON.stringify(remu || {});

      row.innerHTML = `
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>codCateg</label>
            <input type="text" class="form-control remu-codCateg has-placeholder" value="${remu.contrato.codCateg.categoria || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>contratoTSV</label>
            <input type="text" class="form-control remu-contratoTSV has-placeholder" value="${remu.contrato.contratoTSV || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>dtAdm</label>
            <input type="text" class="form-control remu-dtAdm has-placeholder" value="${remu.contrato.dtAdm || ''}">
          </div>
          <div class="form-group col-md-3">
            <label>Matrícula</label>
            <input type="text" class="form-control remu-matricula has-placeholder" value="${remu.contrato.matricula || ''}">
          </div>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-outline-danger remove-remu-btn">Remover Remuneração</button>
        </div>
        <h6>Itens de Rubrica</h6>
        <div class="itens-container"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary add-item-btn">Adicionar Item</button>
      `;
      container.appendChild(row);
      row.querySelector(".remove-remu-btn").onclick = () => {
        row.remove();
      };

      const itensContainer = row.querySelector(".itens-container");
      if (remu.s1202RemuTrabRPPSItens && remu.s1202RemuTrabRPPSItens.length) {
        remu.s1202RemuTrabRPPSItens.forEach((i) => addItemRow(itensContainer, i));
      }
      row.querySelector(".add-item-btn").onclick = () => {
        const newItem = {
          codRubr: { codRubr: "", iniValid: "" },
          fatorRubr: "",
          ideTabRubr: "",
          indApurIR: "",
          qtdRubr: "",
          vrRubr: "",
          // Campo exigido pelo layout de integração observado no seu lote: manter mesmo quando "vazio"
          s1202RemuTrabRPPSDescFolha: [
            { instFinanc: "*vazio*", nrDoc: "*vazio*", observacao: "*vazio*", tpDesc: "*numerovazio*" }
          ]
        };
        if (!remu.s1202RemuTrabRPPSItens) {
          remu.s1202RemuTrabRPPSItens = [];
        }
        remu.s1202RemuTrabRPPSItens.push(newItem);
        addItemRow(itensContainer, newItem);
      };

      addPlaceholderDropdowns();
    }

    function addItemRow(container, item) {
      const row = document.createElement("div");
      row.className = "border p-2 mb-2 item-row";
      row.dataset.original = JSON.stringify(item || {});

      row.innerHTML = `
        <div class="form-row">
          <div class="form-group col-md-2">
            <label>codRubr</label>
            <input type="text" class="form-control item-codRubr has-placeholder" value="${item.codRubr.codRubr || ''}">
          </div>
          <div class="form-group col-md-2">
            <label>iniValid</label>
            <input type="text" class="form-control item-iniValid has-placeholder" value="${item.codRubr.iniValid || ''}">
          </div>
          <div class="form-group col-md-2">
            <label>fatorRubr</label>
            <input type="text" class="form-control item-fatorRubr has-placeholder" value="${item.fatorRubr || ''}">
          </div>
          <div class="form-group col-md-2">
            <label>ideTabRubr</label>
            <input type="text" class="form-control item-ideTabRubr has-placeholder" value="${item.ideTabRubr || ''}">
          </div>
          <div class="form-group col-md-2">
            <label>indApurIR</label>
            <input type="text" class="form-control item-indApurIR has-placeholder" value="${item.indApurIR || ''}">
          </div>
          <div class="form-group col-md-1">
            <label>qtdRubr</label>
            <input type="text" class="form-control item-qtdRubr has-placeholder" value="${item.qtdRubr || ''}">
          </div>
          <div class="form-group col-md-1">
            <label>Valor</label>
            <input type="text" class="form-control item-vrRubr has-placeholder" value="${item.vrRubr || ''}">
          </div>
        </div>
        <button type="button" class="btn btn-outline-danger remove-item-btn">Remover Item</button>
      `;
      container.appendChild(row);
      row.querySelector(".remove-item-btn").onclick = () => {
        if (confirm("Remover este item?")) {
          row.remove();
        }
      };
      addPlaceholderDropdowns();
    }
 // 7) SALVAR EVENTO
    document.getElementById("saveEventoBtn").onclick = () => {
      let evtOriginal = currentEditingEventOriginal;
      let evtAtualizado = JSON.parse(JSON.stringify(evtOriginal));

      evtAtualizado.ordemRegistro = safeValue(document, "#ordemRegistro");
      evtAtualizado.chaveIntegracao = safeValue(document, "#chaveIntegracao");
      evtAtualizado.anoApur = safeValue(document, "#anoApur");
      evtAtualizado.indApuracao = safeValue(document, "#indApuracao");
      evtAtualizado.indPossuiPerAnt = safeValue(document, "#indPossuiPerAnt");
      evtAtualizado.perApur = safeValue(document, "#perApur");
      evtAtualizado.empregador.nrInsc = safeValue(document, "#empregador_nrInsc");
      evtAtualizado.empregador.tpInsc.tipo = safeValue(document, "#empregador_tpInsc_tipo");
      evtAtualizado.trabalhador.cpfTrab = safeValue(document, "#trabalhador_cpfTrab");
      evtAtualizado.nmTrabComplem = safeValue(document, "#nmTrabComplem");

      // Salvar pagamentos
      const pagCards = document.querySelectorAll(".pagamento-card");
      evtAtualizado.s1202RemuTrabRPPSPagtos = Array.from(pagCards).map((card) => {
        const originalPagto = JSON.parse(card.dataset.original || "{}");
        const updatedPagto = {
          codCateg: { categoria: safeValue(card, ".pagto-categoria") },
          descRRA: safeValue(card, ".pagto-descRRA"),
          ideDmDev: safeValue(card, ".pagto-ideDmDev"),
          indRRA: safeValue(card, ".pagto-indRRA"),
          nrProcRRA: safeValue(card, ".pagto-nrProcRRA"),
          qtdMesesRRA: safeValue(card, ".pagto-qtdMesesRRA"),
          remunOrgSuc: safeValue(card, ".pagto-remunOrgSuc"),
          tpProcRRA: safeValue(card, ".pagto-tpProcRRA"),
          vlrDespAdvogados: safeValue(card, ".pagto-vlrDespAdvogados"),
          vlrDespCustas: safeValue(card, ".pagto-vlrDespCustas"),
          s1202RemuTrabRPPSIdeAdv: getIdeAdvFromCard(card) || originalPagto.s1202RemuTrabRPPSIdeAdv,
          s1202RemuTrabRPPSPer: getPeriodsFromCard(card) || originalPagto.s1202RemuTrabRPPSPer
        };
        return mergeDeep(originalPagto, updatedPagto);
      });

      
      // Validação adicional: ideDmDev (tamanho máximo). Muitos validadores/integrações rejeitam > 30 caracteres.
      const ideProblems = validateIdeDmDevInEvento(evtAtualizado);
      if (ideProblems.length) {
        const linhas = ideProblems.map(p => {
          const base = `- Pagamento #${p.idx + 1}: ideDmDev="${p.ide}"`;
          if (p.issue === "vazio") return base + " (vazio)";
          return base + ` (tamanho=${(p.ide||'').length}). Sugestão: "${p.fix}"`;
        }).join("\\n");
        const msg = "Foram encontrados problemas no ideDmDev (demonstrativo) que podem impedir a importação:\\n\\n" + linhas +
          "\\n\\nDeseja aplicar correção automática (recomendado) e continuar?";
        if (confirm(msg)) {
          applyIdeDmDevAutoFix(evtAtualizado, ideProblems.filter(p => p.fix));
        } else {
          return;
        }
      }
// Insere ou atualiza
      if (currentEditingEventIndex === null) {
        getEventos().push(evtAtualizado);
      } else {
        // Importante para auditoria/integridade: não substituir o objeto inteiro (isso muda ordem/inserção de chaves).
        // Faz merge no objeto original, preservando campos não exibidos no modal e mantendo a ordem de chaves existente.
        const target = getEventos()[currentEditingEventIndex];
        mergeDeep(target, evtAtualizado);
      }

      $("#eventoModal").modal("hide");
      renderEventosTable();
      if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();
    };

    // ----------------------------------------------------------------------
    // 8) CARREGAR ARQUIVO
    const fileInput = document.getElementById("fileInput");
    fileInput.addEventListener("change", function () {
      const file = this.files && this.files[0];
      if (!file) return;

      loadedFileName = file.name || null;
      loadedFileMeta = { name: file.name || "", size: file.size || 0, lastModified: file.lastModified || 0 };

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const parsed = parseJsonSafely(e.target.result);
          window.esocialData = parsed.data;

          // Garante estrutura e marcação interna
          getEventos().forEach((evt) => {
            if (typeof evt._selected === "undefined") {
              evt._selected = false;
            }
          });

          renderEventosTable();
          if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();

          if (parsed.repaired) {
            alert("Arquivo carregado com sucesso (foi aplicado um reparo mínimo para leitura: BOM e/ou vírgula sobrando). Recomenda-se validar o conteúdo antes da transmissão.");
          } else {
            alert("Arquivo carregado com sucesso!");
          }
        } catch (err) {
          alert("Erro ao ler JSON: " + err);
        }
      };
      reader.readAsText(file);

      // Permite recarregar o mesmo arquivo sem precisar selecionar outro
      this.value = "";
    });

    // ----------------------------------------------------------------------
    // 9) BAIXAR ARQUIVO
    function gerarArquivoEsocialFormatado(data) {
      const eventos = data?.s1202RemuTrabRPPSGroup?.s1202RemuTrabRPPS || [];
      let resultado = '{"s1202RemuTrabRPPSGroup":{"s1202RemuTrabRPPS":[';
      for (let i = 0; i < eventos.length; i++) {
        const copia = JSON.parse(JSON.stringify(eventos[i]));
        delete copia._selected; // remove seleção interna
        const eStr = JSON.stringify(copia, null, 0);
        resultado += (i === 0 ? "\n" : "\n,") + eStr;
      }
      resultado += "\n]}}";
      return resultado;
    }

    function gerarNomeArquivo() {
      const eventos = getEventos();
      if (eventos.length > 0) {
        const evt = eventos[0];
        const chave = evt.chaveIntegracao || "";
        // Exemplo de chave: "1#11239018#05668501760#2023#01032023#1"
        const parts = chave.split("#");
        if (parts.length >= 6) {
          const ano = parts[3];
          const dataRef = parts[4];
          const tipoApur = parts[5];
          return `S-1202_${ano}_${dataRef}_${tipoApur}.json`;
        }
      }
      return "S-1202_editor.json";
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      try {
        
        // Validação adicional antes do download: ideDmDev (tamanho máximo)
        const eventos = getEventos();
        let problemasAll = [];
        eventos.forEach((evt, idxEvt) => {
          const probs = validateIdeDmDevInEvento(evt);
          if (probs.length) {
            probs.forEach(p => problemasAll.push({ idxEvt, ...p }));
          }
        });
        if (problemasAll.length) {
          const linhas = problemasAll.map(p => {
            const base = `- Evento #${p.idxEvt + 1} / Pagamento #${p.idx + 1}: ideDmDev="${p.ide}"`;
            if (p.issue === "vazio") return base + " (vazio)";
            return base + ` (tamanho=${(p.ide||'').length}). Sugestão: "${p.fix}"`;
          }).join("\\n");
          const msg = "Antes de gerar o arquivo, foram encontrados ideDmDev inválidos (podem impedir importação):\\n\\n" + linhas +
            "\\n\\nDeseja aplicar correção automática (recomendado) e continuar?";
          if (confirm(msg)) {
            eventos.forEach(evt => applyIdeDmDevAutoFix(evt, validateIdeDmDevInEvento(evt).filter(p => p.fix)));
          } else {
            return;
          }
        }

const dataStr = gerarArquivoEsocialFormatado(window.esocialData);
        const blob = new Blob([dataStr], { type: "application/json;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        const suggestedName = buildEditedFileName(loadedFileName) || gerarNomeArquivo();
        link.setAttribute("download", suggestedName);
        link.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert("Erro ao gerar download: " + err);
      }
    });

    // ----------------------------------------------------------------------
    // 10) SCRIPTS (Substituição Global)
    document.getElementById("applyScriptBtn").addEventListener("click", () => {
      const scope = document.getElementById("scriptScope").value;
      const field = document.getElementById("scriptField").value.trim();
      const oldVal = document.getElementById("scriptOldValue").value.trim();
      const newVal = document.getElementById("scriptNewValue").value.trim();

      if (!field) {
        alert("Informe o nome do campo a substituir.");
        return;
      }

      function replaceInEvento(evt) {
        if (scope === "evento") {
          if (evt.hasOwnProperty(field)) {
            if (!oldVal || evt[field] === oldVal) {
              evt[field] = newVal;
            }
          }
        }
        if (["pagto", "periodo", "estab", "remu", "item"].includes(scope)) {
          (evt.s1202RemuTrabRPPSPagtos || []).forEach((p) => {
            if (scope === "pagto") {
              if (p.hasOwnProperty(field)) {
                if (!oldVal || p[field] === oldVal) {
                  p[field] = newVal;
                }
              }
            }
            (p.s1202RemuTrabRPPSPer || []).forEach((period) => {
              if (scope === "periodo") {
                if (period.hasOwnProperty(field)) {
                  if (!oldVal || period[field] === oldVal) {
                    period[field] = newVal;
                  }
                }
              }
              (period.s1202RemuTrabRPPSEstab || []).forEach((est) => {
                if (scope === "estab") {
                  if (est.hasOwnProperty(field)) {
                    if (!oldVal || est[field] === oldVal) {
                      est[field] = newVal;
                    }
                  }
                  if (est.nrInsc && ["iniValid", "nrInsc", "tipo"].includes(field)) {
                    if (!oldVal || est.nrInsc[field] === oldVal) {
                      est.nrInsc[field] = newVal;
                    }
                  }
                }
                (est.s1202RemuTrabRPPSRemu || []).forEach((r) => {
                  if (scope === "remu") {
                    if (r.contrato.hasOwnProperty(field)) {
                      if (!oldVal || r.contrato[field] === oldVal) {
                        r.contrato[field] = newVal;
                      }
                    }
                    if (field === "codCateg") {
                      if (!oldVal || r.contrato.codCateg.categoria === oldVal) {
                        r.contrato.codCateg.categoria = newVal;
                      }
                    }
                  }
                  (r.s1202RemuTrabRPPSItens || []).forEach((i) => {
                    if (scope === "item") {
                      if (i.hasOwnProperty(field)) {
                        if (!oldVal || i[field] === oldVal) {
                          i[field] = newVal;
                        }
                      }
                      if (i.codRubr && ["codRubr", "iniValid"].includes(field)) {
                        if (!oldVal || i.codRubr[field] === oldVal) {
                          i.codRubr[field] = newVal;
                        }
                      }
                    }
                  });
                });
              });
            });
          });
        }
      }

      getEventos().forEach((e) => replaceInEvento(e));
      $("#scriptsModal").modal("hide");
      renderEventosTable();
      alert(`Substituição concluída! Campo '${field}' -> '${newVal}'.`);
    });

    // ----------------------------------------------------------------------
	// 11) MARCAR / DESMARCAR TODOS — agora respeitando o filtro de busca
	function eventoCorrespondeFiltro(evt) {
	  const search = (document.getElementById("searchInput").value || "")
					   .toLowerCase();
	  if (!search) return true;                       // nada digitado? mostra tudo
	  return JSON.stringify(evt).toLowerCase().includes(search);
	}

	document.getElementById("selectAllBtn").addEventListener("click", () => {
	  getEventos().forEach(evt => {
		if (eventoCorrespondeFiltro(evt)) {
		  evt._selected = true;                       // marca só os visíveis
		}
	  });
	  renderEventosTable();
	});

	document.getElementById("deselectAllBtn").addEventListener("click", () => {
	  getEventos().forEach(evt => {
		if (eventoCorrespondeFiltro(evt)) {
		  evt._selected = false;                      // desmarca só os visíveis
		}
	  });
	  renderEventosTable();
	});

    // ----------------------------------------------------------------------
    // 12) REMOVER SELECIONADOS
    document.getElementById("removeSelectedBtn").addEventListener("click", () => {
      if (!confirm("Deseja remover todos os selecionados?")) return;
      let eventos = getEventos();
      let novos = eventos.filter((e) => !e._selected);
      window.esocialData.s1202RemuTrabRPPSGroup.s1202RemuTrabRPPS = novos;
      renderEventosTable();
      if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();
    });

    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
// 13) AJUSTAR PAGAMENTOS NEGATIVOS (com modal, prévia e confirmação)
const ajustarBtn = document.getElementById("ajustarRubricasBtn");
if (ajustarBtn) {
  ajustarBtn.addEventListener("click", () => {
    buildNegativosPreview();
    $("#negativosModal").modal("show");
  });
}

const applyNegBtn = document.getElementById("applyNegativosBtn");
if (applyNegBtn) {
  applyNegBtn.addEventListener("click", () => {
    const skipIfExists = !!document.getElementById("negSkipIfExistsChk")?.checked;
    const prev = analyzeNegativos(5000);
    if (!prev.cases.length) {
      alert("Não foi encontrada nenhuma soma negativa para ajustar.");
      $("#negativosModal").modal("hide");
      return;
    }
    if (!confirm(`Foram encontrados ${prev.cases.length} demonstrativo(s) com saldo negativo. Deseja aplicar o ajuste (998V) agora?`)) return;

    const res = aplicarAjusteNegativos(skipIfExists);
    $("#negativosModal").modal("hide");
    renderEventosTable();
    if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();
    alert(`Concluído. Ajustes aplicados: ${res.aplicados}. Ignorados (já existia 998V no mesmo perRef): ${res.ignoradosExistente}.`);
  });
}

function parseToFloat(str) {
  if (!str) return 0;
  let val = String(str).replace(",", ".");
  let num = parseFloat(val);
  return isNaN(num) ? 0 : num;
}

function formatNumberBR(num, decimals = 4) {
  const n = Number(num || 0);
  try {
    return n.toLocaleString("pt-BR", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  } catch {
    return n.toFixed(decimals);
  }
}

function analyzeNegativos(maxRows = 200) {
  const casos = [];
  let totalAjuste = 0;

  getEventos().forEach((evt) => {
    const cpf = normalizeCpf(evt?.trabalhador?.cpfTrab || "");

    (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
      let soma = 0;
      const periodos = pagto.s1202RemuTrabRPPSPer || [];

      periodos.forEach((periodo) => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach((estab) => {
          (estab.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
            (remu.s1202RemuTrabRPPSItens || []).forEach((item) => {
              if (item.ideTabRubr === "VANT") soma += parseToFloat(item.vrRubr);
              else if (item.ideTabRubr === "DESC") soma -= parseToFloat(item.vrRubr);
            });
          });
        });
      });

      if (soma < 0) {
        const ajuste = Math.abs(soma);
        totalAjuste += ajuste;

        const ultimoPeriodo = periodos.length ? periodos[periodos.length - 1] : null;
        const perRefAlvo = ultimoPeriodo ? (ultimoPeriodo.perRef || "") : "";

        casos.push({
          cpf: cpf || "(sem CPF)",
          ideDmDev: (pagto.ideDmDev || "(sem ideDmDev)"),
          perRef: perRefAlvo || "(sem perRef)",
          saldo: soma,
          ajuste
        });
      }
    });
  });

  // ordena por maior ajuste (desc)
  casos.sort((a, b) => b.ajuste - a.ajuste);

  return { cases: casos.slice(0, maxRows), totalCases: casos.length, totalAjuste };
}

function buildNegativosPreview() {
  const box = document.getElementById("negativosPreview");
  const tbody = document.getElementById("negativosTableBody");
  if (!box || !tbody) return;

  if (!loadedFileMeta) {
    box.innerHTML = '<span class="text-muted">Carregue um arquivo para visualizar a prévia.</span>';
    tbody.innerHTML = '<tr><td colspan="5" class="text-muted">—</td></tr>';
    return;
  }

  const res = analyzeNegativos(200);
  box.innerHTML = `
    <div><strong>Prévia</strong></div>
    <div>Demonstrativos com saldo negativo: <strong>${res.totalCases}</strong></div>
    <div>Total a ajustar (somatório): <strong>${formatNumberBR(res.totalAjuste, 4)}</strong></div>
    <div class="text-muted mt-1">A tabela abaixo mostra até 200 casos (ordenados por maior ajuste).</div>
  `;

  if (!res.cases.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Nenhum caso encontrado.</td></tr>';
    return;
  }

  tbody.innerHTML = res.cases.map(c => `
    <tr>
      <td>${escapeHtml(c.cpf)}</td>
      <td class="text-muted">${escapeHtml(c.ideDmDev)}</td>
      <td>${escapeHtml(c.perRef)}</td>
      <td class="text-right">${escapeHtml(formatNumberBR(c.saldo, 4))}</td>
      <td class="text-right">${escapeHtml(formatNumberBR(c.ajuste, 4))}</td>
    </tr>
  `).join("");
}

function item998vJaExisteNoPerRef(ultimoPeriodo) {
  const perRef = ultimoPeriodo?.perRef || "";
  let existe = false;

  (ultimoPeriodo?.s1202RemuTrabRPPSEstab || []).forEach((est) => {
    (est.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
      (remu.s1202RemuTrabRPPSItens || []).forEach((item) => {
        const cod = item?.codRubr?.codRubr || "";
        const ini = item?.codRubr?.iniValid || "";
        if (String(cod).toUpperCase() === "998V" && String(ini) === String(perRef)) {
          existe = true;
        }
      });
    });
  });

  return existe;
}

function aplicarAjusteNegativos(skipIfExists = true) {
  let aplicados = 0;
  let ignoradosExistente = 0;

  getEventos().forEach((evt) => {
    (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
      let soma = 0;
      const periodos = pagto.s1202RemuTrabRPPSPer || [];

      periodos.forEach((periodo) => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach((estab) => {
          (estab.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
            (remu.s1202RemuTrabRPPSItens || []).forEach((item) => {
              if (item.ideTabRubr === "VANT") soma += parseToFloat(item.vrRubr);
              else if (item.ideTabRubr === "DESC") soma -= parseToFloat(item.vrRubr);
            });
          });
        });
      });

      if (soma >= 0) return;

      const ultimoPeriodo = periodos.length ? periodos[periodos.length - 1] : null;
      if (!ultimoPeriodo) return;

      if (skipIfExists && item998vJaExisteNoPerRef(ultimoPeriodo)) {
        ignoradosExistente++;
        return;
      }

      const diferencaNum = Math.abs(soma);
      if (!(diferencaNum > Number.EPSILON)) return;

      const diferenca = diferencaNum.toFixed(4);
      if (parseFloat(diferenca) <= 0) return;

      // Alvo: adicionar 998V em apenas um ponto (primeira remuneração disponível do último período)
      let aplicadoAqui = false;
      (ultimoPeriodo.s1202RemuTrabRPPSEstab || []).some((est) => {
        return (est.s1202RemuTrabRPPSRemu || []).some((remu) => {
          if (!remu.s1202RemuTrabRPPSItens) remu.s1202RemuTrabRPPSItens = [];

          const novoItem = {
            codRubr: { codRubr: "998V", iniValid: ultimoPeriodo.perRef },
            fatorRubr: "*numerovazio*",
            ideTabRubr: "VANT",
            indApurIR: "0",
            qtdRubr: "*numerovazio*",
            vrRubr: diferenca,
            // Campo estrutural que costuma existir no arquivo original (evita falhas de importação)
            s1202RemuTrabRPPSDescFolha: [
              { descFolha: "*vazio*" }
            ]
          };

          remu.s1202RemuTrabRPPSItens.push(novoItem);
          aplicadoAqui = true;
          return true;
        });
      });

      if (aplicadoAqui) aplicados++;
    });
  });

  return { aplicados, ignoradosExistente };
}

    // 14) VERIFICAR PERÍODOS ANTERIORES e RRA
    document.getElementById("verificarPeriodosBtn").addEventListener("click", () => {
      // Abre modal para configurar
      $("#verificarModal").modal("show");
    });

    document.getElementById("applyVerificarBtn").addEventListener("click", () => {
      const descRRA = document.getElementById("verifDescRRA").value.trim();
      const tpProcRRA = document.getElementById("verifTpProcRRA").value.trim();
      const rra032023 = document.getElementById("verifRRA032023").checked;

      verificarPeriodosAnterioresRRA(descRRA, tpProcRRA, rra032023);
      $("#verificarModal").modal("hide");
      renderEventosTable();
      alert("Verificação de períodos / RRA concluída!");
    });

    // Lógica atualizada:
    // 1) "Possui Período Anterior?" => "S" se 'perRef'(YYYYMM) < 'perApur'(YYYYMM)
    // 2) RRA => se ano(perRef) < ano(perApur) => indRRA="S", senão "*vazio*"
    // 3) Ajusta descRRA, qtdMesesRRA, tpProcRRA se RRA="S"
    // 4) Ajusta indApurIR = "0"
    // 5) Se "RRA 03/2023" => zera tudo

    function verificarPeriodosAnterioresRRA(descRRA, tpProcRRA, rra032023) {
      const eventos = getEventos();

      eventos.forEach((evt) => {
        const apurNum = parseYearMonth(evt.perApur); // p/ Passo1
        const anoApur = parseYear(evt.perApur);      // p/ Passo2

        let possuiMesAnterior = false; // se algum perRefNum < apurNum

        (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
          let existeAnoAnterior = false; // para RRA

          (pagto.s1202RemuTrabRPPSPer || []).forEach((periodo) => {
            const perRefNum = parseYearMonth(periodo.perRef);
            const perRefAno = parseYear(periodo.perRef);

            // Passo1: se perRefNum < apurNum => "Possui Período Anterior?"
            if (perRefNum && apurNum && perRefNum < apurNum) {
              possuiMesAnterior = true;
            }

            // Passo2: se perRefAno < anoApur => RRA = S
            if (perRefAno && anoApur && perRefAno < anoApur) {
              existeAnoAnterior = true;
            }

            // Passo4: indApurIR => "0"
            (periodo.s1202RemuTrabRPPSEstab || []).forEach((est) => {
              (est.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
                (remu.s1202RemuTrabRPPSItens || []).forEach((item) => {
                  if (perRefAno < anoApur) item.indApurIR = "0";
                  else item.indApurIR = "0";
                });
              });
            });
          });

          if (rra032023) {
            // zera indRRA
            pagto.indRRA = "*vazio*";
            pagto.descRRA = "*vazio*";
            pagto.qtdMesesRRA = "*numerovazio*";
            pagto.tpProcRRA = "*vazio*";
          } else {
            if (existeAnoAnterior) {
              pagto.indRRA = "S";
              // Preenche descRRA e tals
              pagto.descRRA = descRRA || "";
              pagto.tpProcRRA = tpProcRRA || "";
              // qtdMesesRRA = quantos perRef com ano < anoApur
              let countAnos = 0;
              if (pagto.s1202RemuTrabRPPSPer) {
                pagto.s1202RemuTrabRPPSPer.forEach((per) => {
                  const pAno = parseYear(per.perRef);
                  if (pAno && pAno < anoApur) {
                    countAnos++;
                  }
                });
              }
              if (countAnos === 0) pagto.qtdMesesRRA = "*numerovazio*";
              else pagto.qtdMesesRRA = String(countAnos);
            } else {
              pagto.indRRA = "*vazio*";
              pagto.descRRA = "*vazio*";
              pagto.qtdMesesRRA = "*numerovazio*";
              pagto.tpProcRRA = "*vazio*";
            }
          }
        });

        // Ao final do for, define se "S" ou "N"
        evt.indPossuiPerAnt = possuiMesAnterior ? "S" : "N";
      });
    }

    // ----------------------------------------------------------------------
    // 15) MESCLAR EVENTOS PELA MESMA CHAVE
    document.getElementById("mergeBtn").addEventListener("click", mesclarEventos);

function mesclarEventos() {
  const eventos = getEventos();
  let agrupados = {};

  // 1) Agrupa eventos pela chaveIntegracao
  eventos.forEach((evt) => {
    const chave = evt.chaveIntegracao || "";
    if (!agrupados[chave]) {
      agrupados[chave] = [];
    }
    agrupados[chave].push(evt);
  });

  let novaLista = [];

  // 2) Para cada grupo (chaveIntegracao), mescla e renomeia
  for (let chave in agrupados) {
    const lista = agrupados[chave];

    // Pega o primeiro evento do grupo como “base”
    let eventoBase = lista[0];
    if (!eventoBase.s1202RemuTrabRPPSPagtos) {
      eventoBase.s1202RemuTrabRPPSPagtos = [];
    }

    // Se houver mais de um evento nessa mesma chave, concatena os pagamentos
    for (let i = 1; i < lista.length; i++) {
      let outro = lista[i];
      if (outro.s1202RemuTrabRPPSPagtos && outro.s1202RemuTrabRPPSPagtos.length > 0) {
        eventoBase.s1202RemuTrabRPPSPagtos.push(...outro.s1202RemuTrabRPPSPagtos);
      }
    }

    // 3) Renomeia ideDmDev duplicados
    //    (inclui caso de somente 1 evento na chave, mas com vários demonstrativos iguais)
    let vistos = {};
    eventoBase.s1202RemuTrabRPPSPagtos.forEach((pagto) => {
      let original = pagto.ideDmDev || "";
      if (!vistos[original]) {
        vistos[original] = 1;
      } else {
        vistos[original]++;
        pagto.ideDmDev = original + "-" + vistos[original];
      }
    });

    // 4) Adiciona ao resultado final
    novaLista.push(eventoBase);
  }

  // 5) Substitui a lista antiga de eventos pela nova
  window.esocialData.s1202RemuTrabRPPSGroup.s1202RemuTrabRPPS = novaLista;
  renderEventosTable();
  alert(
    "Mesclagem concluída! Eventos com a mesma chaveIntegracao foram unificados e ideDmDev duplicados foram renomeados."
  );
}


    // ----------------------------------------------------------------------
    // ----------------------------------------------------------------------
// Informar Categoria e Estabelecimento (modal unificado, com integridade)
// Observação: o antigo modal/botão de Estabelecimentos foi mantido como legado (oculto),
// mas o fluxo recomendado é via "Informar Categoria e Estabelecimento".

function onlyDigits(v) {
  return String(v || "").replace(/\D+/g, "");
}

function isPlaceholderValue(v) {
  const s = String(v || "").trim();
  return s === "" || s === "*vazio*" || s === "*numerovazio*" || s === "*datavazia*";
}

function isValidIsoDate(d) {
  const s = String(d || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
  const dt = new Date(s + "T00:00:00");
  if (Number.isNaN(dt.getTime())) return false;
  // Checa se a data "volta" igual (evita 2024-02-31 virar março automaticamente)
  const [y, m, dd] = s.split("-").map(Number);
  return dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === dd;
}

function aplicarEstabelecimentos(iniValid, nrInscRaw, tpInscRaw, overwrite = false) {
  const nrInsc = onlyDigits(nrInscRaw);
  const tpInsc = String(tpInscRaw || "").trim();

  let totalEstabs = 0;
  let alterados = 0;

  const eventos = getEventos();
  eventos.forEach((evt) => {
    (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
      (pagto.s1202RemuTrabRPPSPer || []).forEach((periodo) => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach((est) => {
          totalEstabs++;

          // Detecta "vazio" com segurança
          const atualNr = est && est.nrInsc && est.nrInsc.nrInsc ? String(est.nrInsc.nrInsc) : "";
          const atualIni = est && est.nrInsc && est.nrInsc.iniValid ? String(est.nrInsc.iniValid) : "";
          const atualTp  = est && est.nrInsc && est.nrInsc.tpInsc && est.nrInsc.tpInsc.tipo ? String(est.nrInsc.tpInsc.tipo) : "";

          const precisa = overwrite || isPlaceholderValue(atualNr);

          if (!precisa) return;

          if (!est.nrInsc) est.nrInsc = {};
          est.nrInsc.iniValid = iniValid;
          est.nrInsc.nrInsc = nrInsc;
          if (!est.nrInsc.tpInsc) est.nrInsc.tpInsc = {};
          est.nrInsc.tpInsc.tipo = tpInsc;

          alterados++;
        });
      });
    });
  });

  return { totalEstabs, alterados };
}

function countCategPlaceholders() {
  let total = 0;
  getEventos().forEach(evt => {
    (evt.s1202RemuTrabRPPSPagtos || []).forEach(pagto => {
      (pagto.s1202RemuTrabRPPSPer || []).forEach(periodo => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach(estab => {
          (estab.s1202RemuTrabRPPSRemu || []).forEach(remu => {
            const cur = remu && remu.contrato && remu.contrato.codCateg ? remu.contrato.codCateg.categoria : "";
            if (cur === "*numerovazio*" || cur === "" || cur == null) total++;
          });
        });
      });
    });
  });
  return total;
}

function countEstabsVazios() {
  let vazios = 0;
  let total = 0;
  getEventos().forEach(evt => {
    (evt.s1202RemuTrabRPPSPagtos || []).forEach(pagto => {
      (pagto.s1202RemuTrabRPPSPer || []).forEach(periodo => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach(est => {
          total++;
          const atualNr = est && est.nrInsc && est.nrInsc.nrInsc ? String(est.nrInsc.nrInsc) : "";
          if (isPlaceholderValue(atualNr)) vazios++;
        });
      });
    });
  });
  return { total, vazios };
}

function buildCategEstabPreview() {
  const box = document.getElementById("categEstabPreview");
  if (!box) return;

  if (!loadedFileMeta) {
    box.innerHTML = '<span class="text-muted">Carregue um arquivo para visualizar a prévia.</span>';
    return;
  }

  const cat = countCategPlaceholders();
  const est = countEstabsVazios();

  box.innerHTML = `
    <div><strong>Prévia</strong></div>
    <div>Categoria com placeholder/vazio: <strong>${cat}</strong></div>
    <div>Estabelecimentos vazios: <strong>${est.vazios}</strong> de <strong>${est.total}</strong></div>
    <div class="text-muted mt-1">Dica: por padrão o editor só preenche vazios. Habilite sobrescrita apenas quando necessário.</div>
  `;
}

// Legado: botão/modal de estabelecimentos (oculto)
const estabBtnLegacy = document.getElementById("estabBtn");
if (estabBtnLegacy) {
  estabBtnLegacy.addEventListener("click", () => $("#estabModal").modal("show"));
}

const applyEstabLegacy = document.getElementById("applyEstabBtn");
if (applyEstabLegacy) {
  applyEstabLegacy.addEventListener("click", () => {
    const iniValid = document.getElementById("estabIniValid").value.trim();
    const nrInsc = document.getElementById("estabNrInsc").value.trim();
    const tpInsc = document.getElementById("estabTpInsc").value.trim();

    if (!isValidIsoDate(iniValid)) {
      alert("iniValid inválido. Use o formato YYYY-MM-DD (ex.: 2021-07-01).");
      return;
    }
    const cnpj = onlyDigits(nrInsc);
    if (cnpj.length !== 14) {
      alert("nrInsc inválido. Informe um CNPJ com 14 dígitos.");
      return;
    }

    aplicarEstabelecimentos(iniValid, cnpj, tpInsc, false);
    $("#estabModal").modal("hide");
    renderEventosTable();
    if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();
    alert("Estabelecimentos preenchidos (apenas vazios).");
  });
}

// Modal unificado (categoria + estabelecimento)
const categBtn = document.getElementById("categRemuBtn");
if (categBtn) {
  categBtn.addEventListener("click", () => {
    buildCategEstabPreview();
    $("#categRemuModal").modal("show");
  });
}

const applyCategBtn = document.getElementById("applyCategRemuBtn");
if (applyCategBtn) {
  applyCategBtn.addEventListener("click", () => {
    const applyCategoria = !!document.getElementById("applyCategoriaChk")?.checked;
    const applyEstab = !!document.getElementById("applyEstabChk")?.checked;

    const codigo = (document.getElementById("categRemuValue").value || "").trim();
    const iniValid = (document.getElementById("categEstabIniValid").value || "").trim();
    const nrInscRaw = (document.getElementById("categEstabNrInsc").value || "").trim();
    const tpInsc = (document.getElementById("categEstabTpInsc").value || "").trim();
    const overwrite = !!document.getElementById("overwriteEstabChk")?.checked;

    let catAlterados = 0;
    let estabAlterados = 0;

    if (applyCategoria) {
      if (!/^\d+$/.test(codigo)) {
        alert("codCateg inválido. Informe apenas números (ex.: 301).");
        return;
      }

      getEventos().forEach(evt => {
        (evt.s1202RemuTrabRPPSPagtos || []).forEach(pagto => {
          (pagto.s1202RemuTrabRPPSPer || []).forEach(periodo => {
            (periodo.s1202RemuTrabRPPSEstab || []).forEach(estab => {
              (estab.s1202RemuTrabRPPSRemu || []).forEach(remu => {
                if (remu && remu.contrato && remu.contrato.codCateg) {
                  const cur = remu.contrato.codCateg.categoria;
                  if (cur === "*numerovazio*" || cur === "" || cur == null) {
                    remu.contrato.codCateg.categoria = codigo;
                    catAlterados++;
                  }
                }
              });
            });
          });
        });
      });
    }

    if (applyEstab) {
      if (!isValidIsoDate(iniValid)) {
        alert("iniValid inválido. Use o formato YYYY-MM-DD (ex.: 2021-07-01).");
        return;
      }
      const cnpj = onlyDigits(nrInscRaw);
      if (cnpj.length !== 14) {
        alert("nrInsc inválido. Informe um CNPJ com 14 dígitos.");
        return;
      }
      const r = aplicarEstabelecimentos(iniValid, cnpj, tpInsc, overwrite);
      estabAlterados = r.alterados;
    }

    $("#categRemuModal").modal("hide");
    renderEventosTable();
    if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();

    alert(`Concluído. Categoria alterada em ${catAlterados} ponto(s). Estabelecimentos atualizados em ${estabAlterados} ponto(s).`);
  });
}

    // Inicializa a tabela ao carregar
    renderEventosTable();
    if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();

    
    
    // ======================================================================
    // CSV MATRÍCULAS (arquivo único: cpfTrab;matricula;matricula_atual)
    // ======================================================================

    let csvMapping = {}; // cpf -> { matricula_antiga, matricula_atual }
    let csvStats = { totalLinhas: 0, validas: 0, ignoradas: 0, conflitos: 0, delimiter: ";" };

    function normalizeCpf(raw) {
      const digits = String(raw || "").replace(/\D/g, "");
      if (!digits) return "";
      return digits.length < 11 ? digits.padStart(11, "0") : digits;
    }

    function detectDelimiter(line) {
      const s = String(line || "");
      const semi = (s.match(/;/g) || []).length;
      const comma = (s.match(/,/g) || []).length;
      return semi >= comma ? ";" : ",";
    }

    function parseCsvLines(csvText) {
      const t = stripUtf8Bom(String(csvText || ""));
      return t.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    }

    function looksLikeHeader(firstCell) {
      const v = String(firstCell || "").toLowerCase();
      return v.includes("cpf") || v.includes("cpftrab");
    }

    function loadCsvMapping(csvText) {
      const lines = parseCsvLines(csvText);
      const stats = { totalLinhas: lines.length, validas: 0, ignoradas: 0, conflitos: 0, delimiter: ";" };
      const mapping = {};

      if (!lines.length) return { mapping, stats };

      const delimiter = detectDelimiter(lines[0]);
      stats.delimiter = delimiter;

      for (let i = 0; i < lines.length; i++) {
        const cols = lines[i].split(delimiter).map(c => String(c || "").trim());
        if (!cols.length) { stats.ignoradas++; continue; }
        if (i === 0 && looksLikeHeader(cols[0])) { stats.ignoradas++; continue; }
        if (cols.length < 3) { stats.ignoradas++; continue; }

        const cpf = normalizeCpf(cols[0]);
        const matriculaAntiga = cols[1] || "";
        const matriculaAtual = cols[2] || "";
        if (!cpf || !matriculaAntiga || !matriculaAtual) { stats.ignoradas++; continue; }

        if (mapping[cpf]) {
          const prev = mapping[cpf];
          if (prev.matricula_antiga !== matriculaAntiga || prev.matricula_atual !== matriculaAtual) {
            // conflito: preferimos não sobrescrever para evitar atualização errada
            stats.conflitos++;
            continue;
          }
        } else {
          mapping[cpf] = { matricula_antiga: matriculaAntiga, matricula_atual: matriculaAtual };
          stats.validas++;
        }
      }

      return { mapping, stats };
    }

    async function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(reader.error || new Error("Falha ao ler arquivo"));
        reader.readAsText(file);
      });
    }

    function updateCsvStatus(extraMessage) {
      const el = document.getElementById("csvStatus");
      if (!el) return;

      const total = Object.keys(csvMapping || {}).length;
      const parts = [];
      if (total) parts.push(`CPFs carregados: ${total}`);
      if (csvStats.totalLinhas) parts.push(`Linhas: ${csvStats.totalLinhas}`);
      if (csvStats.validas) parts.push(`Válidas: ${csvStats.validas}`);
      if (csvStats.ignoradas) parts.push(`Ignoradas: ${csvStats.ignoradas}`);
      if (csvStats.conflitos) parts.push(`Conflitos: ${csvStats.conflitos}`);
      if (csvStats.delimiter) parts.push(`Delim: '${csvStats.delimiter}'`);

      el.textContent = (parts.length ? parts.join(" | ") : "Nenhum CSV carregado ainda.") + (extraMessage ? ` — ${extraMessage}` : "");
    }

    const csvInput = document.getElementById("csvFileInput");
    if (csvInput) {
      csvInput.addEventListener("change", async function () {
        const file = this.files && this.files[0];
        if (!file) return;
        try {
          const txt = await readFileAsText(file);
          const loaded = loadCsvMapping(txt);
          csvMapping = loaded.mapping;
          csvStats = loaded.stats;
          updateCsvStatus("CSV carregado.");
        } catch (err) {
          alert("Erro ao ler CSV: " + err);
        } finally {
          this.value = "";
        }
      });
    }

    function tryHeuristicOldMatricula(matriculaAtual) {
      const s = String(matriculaAtual || "").trim();
      // padrão final "/N" ou "/NN" (1-2 dígitos), ex.: "12345/1" ou "12345/01"
      const m = s.match(/^(.*)\/\d{1,2}$/);
      if (!m) return null;
      const base = (m[1] || "").trim();
      return base || null;
    }

    function forEachContrato(evt, fn) {
      (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
        (pagto.s1202RemuTrabRPPSPer || []).forEach((periodo) => {
          (periodo.s1202RemuTrabRPPSEstab || []).forEach((estab) => {
            (estab.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
              if (remu && remu.contrato) {
                fn(remu.contrato, remu, estab, periodo, pagto);
              }
            });
          });
        });
      });
    }

    // Execução: percorre contratos e substitui matrícula atual pela antiga (baseado no CPF do evento)
    document.getElementById("analisarMatriculasBtn").addEventListener("click", function () {
      try {
        const eventos = getEventos();
        const useHeuristic = !!(document.getElementById("csvHeuristicSuffix") && document.getElementById("csvHeuristicSuffix").checked);

        let contratosVisitados = 0;
        let totalAlterados = 0;
        let totalSemBase = 0;
        let totalMismatchAtual = 0;

        eventos.forEach((evt) => {
          const cpf = normalizeCpf(evt.trabalhador && evt.trabalhador.cpfTrab ? evt.trabalhador.cpfTrab : "");
          if (!cpf) return;

          const reg = csvMapping[cpf];

          forEachContrato(evt, (contrato) => {
            contratosVisitados++;
            const matriculaAtualNoJson = String(contrato.matricula || "");

            if (reg && reg.matricula_antiga && reg.matricula_atual) {
              if (matriculaAtualNoJson === String(reg.matricula_atual)) {
                contrato.matricula = String(reg.matricula_antiga);
                totalAlterados++;
              } else {
                totalMismatchAtual++;
              }
              return;
            }

            // Sem base para o CPF: heurística opcional
            if (useHeuristic && matriculaAtualNoJson) {
              const h = tryHeuristicOldMatricula(matriculaAtualNoJson);
              if (h && h !== matriculaAtualNoJson) {
                contrato.matricula = h;
                totalAlterados++;
              } else {
                totalSemBase++;
              }
            } else {
              totalSemBase++;
            }
          });
        });

        renderEventosTable();
        if (typeof refreshJsonLoadInfo === "function") refreshJsonLoadInfo();
        updateCsvStatus(`Contratos: ${contratosVisitados}. Alterados: ${totalAlterados}. Sem base/heurística: ${totalSemBase}. Divergência matrícula_atual: ${totalMismatchAtual}.`);
        alert(
          "Análise concluída!\n" +
          "Contratos verificados: " + contratosVisitados + "\n" +
          "Matrículas alteradas: " + totalAlterados + "\n" +
          "Sem base/heurística: " + totalSemBase + "\n" +
          "Divergência (matrícula_atual não bate): " + totalMismatchAtual
        );
      } catch (err) {
        alert("Erro ao analisar matrículas: " + err);
      }
    });

    // Status inicial do CSV
    updateCsvStatus();

    // ======================================================================
    // RESUMO DO ARQUIVO CARREGADO (nome, quantidade, agrupamentos)
    // ======================================================================

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, function (ch) {
        return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[ch];
      });
    }

    function formatBytes(bytes) {
      const b = Number(bytes || 0);
      if (!b) return "0 B";
      const units = ["B", "KB", "MB", "GB"];
      let i = 0;
      let v = b;
      while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
      return v.toFixed(i === 0 ? 0 : 2) + " " + units[i];
    }

    function formatDate(ms) {
      if (!ms) return "";
      try { return new Date(ms).toLocaleString("pt-BR"); } catch { return ""; }
    }

    function extractFolhaKey(ideDmDev) {
  const s = String(ideDmDev || "").trim();
  if (!s) return "Sem ideDmDev";
  const up = s.toUpperCase();

  // Prioridade: captura o sufixo do tipo "-NN-TIPO-XXXXXX" (NN = 1-3 dígitos) e mantém o restante até o fim.
  // Ex.: "...-1-NORMAL-122024", "...-11-NORMAL-122024", "...-02-NORMAL-122024-DETALHE"
  const re = /-\d{1,3}-[A-Z0-9_]+-\d{6}/g;
  let last = null;
  let m;
  while ((m = re.exec(up)) !== null) {
    last = m;
  }
  if (last) {
    return up.substring(last.index); // inclui o '-' inicial
  }

  // Fallback: "-TIPO-XXXXXX"
  const re2 = /-[A-Z0-9_]+-\d{6}/g;
  let last2 = null;
  while ((m = re2.exec(up)) !== null) {
    last2 = m;
  }
  if (last2) return up.substring(last2.index);

  return "Outros";
}

function refreshJsonLoadInfo() {
  const container = document.getElementById("jsonLoadInfo");
  if (!container) return;

  if (!loadedFileMeta) {
    container.innerHTML = `<div class="alert alert-secondary p-2 mb-0 small">Nenhum arquivo carregado.</div>`;
    return;
  }

  const eventos = getEventos();
  const totalEventos = eventos.length;

  // CPFs únicos
  const cpfSetGlobal = new Set();
  let eventosSemCpf = 0;
  let eventosSemPeriodo = 0;
  let eventosSemInd = 0;

  // Agrupamento IndApuração + Período
  const indPerMap = new Map(); // key -> { eventos, cpfSet }
  let minYm = null, maxYm = null;

  // Agrupamento folha (por ideDmDev)
  const folhaMap = new Map(); // folhaKey -> { demonstrativos, cpfSet, vantSum, descSum }
  let totalDemonstrativos = 0;
  let demonstrativosSemIde = 0;

  eventos.forEach((evt) => {
    const cpf = normalizeCpf(evt?.trabalhador?.cpfTrab || "");
    if (cpf) cpfSetGlobal.add(cpf); else eventosSemCpf++;

    const ind = (evt.indApuracao || "").trim();
    if (!ind) eventosSemInd++;
    const per = (evt.perApur || "").trim();
    if (!per) eventosSemPeriodo++;

    const ym = parseYearMonth(per);
    if (ym) {
      if (minYm === null || ym < minYm) minYm = ym;
      if (maxYm === null || ym > maxYm) maxYm = ym;
    }

    const key = `${ind || "(vazio)"}|${per || "(vazio)"}`;
    if (!indPerMap.has(key)) indPerMap.set(key, { eventos: 0, cpfSet: new Set() });
    const rec = indPerMap.get(key);
    rec.eventos++;
    if (cpf) rec.cpfSet.add(cpf);

    // demonstrativos (pagtos) por folha
    (evt.s1202RemuTrabRPPSPagtos || []).forEach((pagto) => {
      totalDemonstrativos++;
      const ide = pagto?.ideDmDev ? String(pagto.ideDmDev) : "";
      if (!ide) demonstrativosSemIde++;

      const folhaKey = extractFolhaKey(ide);
      if (!folhaMap.has(folhaKey)) folhaMap.set(folhaKey, { demonstrativos: 0, cpfSet: new Set(), vantSum: 0, descSum: 0 });
      const f = folhaMap.get(folhaKey);
      f.demonstrativos++;
      if (cpf) f.cpfSet.add(cpf);

      // Totais por demonstrativo
      let vant = 0;
      let desc = 0;

      (pagto.s1202RemuTrabRPPSPer || []).forEach((periodo) => {
        (periodo.s1202RemuTrabRPPSEstab || []).forEach((estab) => {
          (estab.s1202RemuTrabRPPSRemu || []).forEach((remu) => {
            (remu.s1202RemuTrabRPPSItens || []).forEach((item) => {
              if (item?.ideTabRubr === "VANT") vant += parseToFloat(item.vrRubr);
              else if (item?.ideTabRubr === "DESC") desc += parseToFloat(item.vrRubr);
            });
          });
        });
      });

      f.vantSum += vant;
      f.descSum += desc;
    });
  });

  function ymToStr(ym) {
    if (!ym) return "";
    const s = String(ym).padStart(6, "0");
    return s.substring(0, 4) + "-" + s.substring(4, 6);
  }

  const indPerRows = Array.from(indPerMap.entries())
    .map(([k, v]) => {
      const [ind, per] = k.split("|");
      return { ind, per, eventos: v.eventos, trabalhadores: v.cpfSet.size };
    })
    .sort((a, b) => (a.per.localeCompare(b.per) || a.ind.localeCompare(b.ind)));

  const folhaRows = Array.from(folhaMap.entries())
    .map(([folha, v]) => {
      const saldo = v.vantSum - v.descSum;
      return { folha, demonstrativos: v.demonstrativos, trabalhadores: v.cpfSet.size, vantSum: v.vantSum, descSum: v.descSum, saldo };
    })
    .sort((a, b) => b.demonstrativos - a.demonstrativos);

  const topFolhas = folhaRows.slice(0, 25);

  const headerHtml = `
    <div class="alert alert-secondary p-2 mb-0">
      <div class="d-flex justify-content-between align-items-center">
        <div class="small">
          <div><strong>Arquivo:</strong> ${escapeHtml(loadedFileMeta.name)} <span class="text-muted">(${formatBytes(loadedFileMeta.size)}, modificado em ${escapeHtml(formatDate(loadedFileMeta.lastModified))})</span></div>
          <div><strong>Eventos:</strong> ${totalEventos} &nbsp;|&nbsp; <strong>Trabalhadores (CPFs únicos):</strong> ${cpfSetGlobal.size} &nbsp;|&nbsp; <strong>Demonstrativos (ideDmDev):</strong> ${totalDemonstrativos}</div>
          <div class="text-muted">Período apuração (mín → máx): ${escapeHtml(ymToStr(minYm) || "—")} → ${escapeHtml(ymToStr(maxYm) || "—")} &nbsp;|&nbsp; Eventos sem CPF: ${eventosSemCpf} &nbsp;|&nbsp; sem indApur: ${eventosSemInd} &nbsp;|&nbsp; sem perApur: ${eventosSemPeriodo}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-dark" id="refreshSummaryBtn">Atualizar resumo</button>
      </div>

      <hr class="my-2">

      <div class="small">
        <div><strong>Trabalhadores por Ind Apuração e Período Apuração</strong></div>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-bordered mb-2">
            <thead class="thead-light">
              <tr>
                <th>Ind Apuração</th>
                <th>Período</th>
                <th>Eventos</th>
                <th>Trabalhadores</th>
              </tr>
            </thead>
            <tbody>
              ${indPerRows.map(r => `
                <tr>
                  <td>${escapeHtml(r.ind)}</td>
                  <td>${escapeHtml(r.per)}</td>
                  <td>${r.eventos}</td>
                  <td>${r.trabalhadores}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div><strong>Demonstrativos por folha (sufixo extraído de ideDmDev)</strong> <span class="text-muted">(ex.: -11-NORMAL-122024 ou -02-NORMAL-122024-DETALHE)</span></div>
        <div class="table-responsive mt-2">
          <table class="table table-sm table-bordered mb-0">
            <thead class="thead-light">
              <tr>
                <th>Folha (chave)</th>
                <th>Demonstrativos</th>
                <th>Trabalhadores</th>
                <th class="text-right">Total VANT</th>
                <th class="text-right">Total DESC</th>
                <th class="text-right">Saldo (VANT-DESC)</th>
              </tr>
            </thead>
            <tbody>
              ${topFolhas.map(r => `
                <tr>
                  <td>${escapeHtml(r.folha)}</td>
                  <td>${r.demonstrativos}</td>
                  <td>${r.trabalhadores}</td>
                  <td class="text-right">${escapeHtml(formatNumberBR(r.vantSum, 4))}</td>
                  <td class="text-right">${escapeHtml(formatNumberBR(r.descSum, 4))}</td>
                  <td class="text-right">${escapeHtml(formatNumberBR(r.saldo, 4))}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div class="text-muted mt-2">
          Observação: o agrupamento por folha usa o último sufixo do padrão <code>-NN-TIPO-XXXXXX</code> em <code>ideDmDev</code> (mantendo o restante até o fim).
          Demonstrativos sem <code>ideDmDev</code>: ${demonstrativosSemIde}.
        </div>
      </div>
    </div>
  `;

  container.innerHTML = headerHtml;

  const btn = document.getElementById("refreshSummaryBtn");
  if (btn) {
    btn.onclick = () => refreshJsonLoadInfo();
  }
}



    // ---------------------------------------------------------------------------
    // FERRAMENTA: FILTRAR / EXCLUIR TRABALHADORES POR CPF
    function parseCpfListToSet(rawText) {
      const set = new Set();
      const tokens = (rawText || "").match(/\d+/g) || [];
      let ignoredTooLong = 0;

      for (const t of tokens) {
        if (t.length > 11) {
          ignoredTooLong++;
          continue;
        }
        const n = normalizeCpf(t);
        if (n) set.add(n);
      }

      return { set, totalTokens: tokens.length, ignoredTooLong };
    }

    function updateCpfFilterStatusUI() {
      const statusEl = document.getElementById("cpfFilterStatus");
      const listEl = document.getElementById("cpfFilterList");
      if (!statusEl || !listEl) return;

      const { set, totalTokens, ignoredTooLong } = parseCpfListToSet(listEl.value);

      let msg = `CPFs informados (após normalização): <strong>${set.size}</strong>`;
      if (totalTokens !== set.size) msg += ` (tokens numéricos detectados: ${totalTokens})`;
      if (ignoredTooLong) msg += ` &mdash; ignorados por terem mais de 11 dígitos: ${ignoredTooLong}`;
      statusEl.innerHTML = msg;
    }

    (function setupCpfFilterTool() {
      const listEl = document.getElementById("cpfFilterList");
      const applyBtn = document.getElementById("applyCpfFilterBtn");
      if (!listEl || !applyBtn) return;

      listEl.addEventListener("input", updateCpfFilterStatusUI);

      // Atualiza status ao abrir o modal
      $("#cpfFilterModal").on("shown.bs.modal", function () {
        updateCpfFilterStatusUI();
        listEl.focus();
      });

      applyBtn.addEventListener("click", function () {
        if (!window.esocialData) {
          alert("Nenhum arquivo JSON carregado.");
          return;
        }

        const mode = (document.querySelector('input[name="cpfFilterMode"]:checked') || {}).value || "keep";
        const { set, ignoredTooLong } = parseCpfListToSet(listEl.value);

        if (!set.size) {
          alert("A lista de CPFs está vazia ou inválida. Informe ao menos um CPF.");
          return;
        }

        const eventos = getEventos();
        const before = eventos.length;

        let matched = 0;
        let missingCpf = 0;

        const kept = [];
        for (const ev of eventos) {
          const cpfRaw = ev?.trabalhador?.cpfTrab;
          const cpfNorm = normalizeCpf(cpfRaw);

          if (!cpfNorm) {
            missingCpf++;
            // Em caso de CPF ausente, por segurança, mantemos o evento.
            kept.push(ev);
            continue;
          }

          const inList = set.has(cpfNorm);
          if (mode === "keep") {
            if (inList) {
              matched++;
              kept.push(ev);
            }
          } else {
            // exclude
            if (inList) {
              matched++;
            } else {
              kept.push(ev);
            }
          }
        }

        const after = kept.length;
        const removed = before - after;

        const modeLabel = mode === "keep" ? "Manter somente CPFs informados" : "Excluir CPFs informados";
        const confirmMsg =
          `${modeLabel}\n\n` +
          `CPFs na lista: ${set.size}\n` +
          `Correspondências encontradas: ${matched}\n` +
          `Eventos antes: ${before}\n` +
          `Eventos removidos: ${removed}\n` +
          `Eventos após: ${after}` +
          (missingCpf ? `\n\nAviso: ${missingCpf} evento(s) sem CPF foram mantidos por segurança.` : "") +
          (ignoredTooLong ? `\n\nObservação: ${ignoredTooLong} token(s) numérico(s) com mais de 11 dígitos foram ignorados.` : "") +
          `\n\nDeseja aplicar esta alteração?`;

        if (!confirm(confirmMsg)) return;

        // Aplica no mesmo nó, preservando a estrutura do JSON, alterando apenas a lista.
        window.esocialData.s1202RemuTrabRPPSGroup.s1202RemuTrabRPPS = kept;

        renderEventos();
        refreshJsonLoadInfo();
        $("#cpfFilterModal").modal("hide");

        alert(`Filtro aplicado. Removidos ${removed} evento(s).`);
      });
    })();


    // -------------------------------------------------------------
    // MESCLAR RUBRICAS POR IDEDMDEV
    (function initMergeDmDevTool() {
      const modalId = "#mergeDmDevModal";
      const openBtn = document.getElementById("mergeDmDevModalBtn");
      const previewEl = document.getElementById("mergeDmDevPreview");
      const applyBtn = document.getElementById("applyMergeDmDevBtn");
      const refreshBtn = document.getElementById("refreshMergeDmDevPreviewBtn");
      const alsoEqEl = document.getElementById("mergeDmDevAlsoEquivalent");
      const alertEl = document.getElementById("mergeDmDevPreviewAlert");

      if (!openBtn || !previewEl || !applyBtn || !refreshBtn || !alsoEqEl) return;

      function deepClone(obj) {
        try {
          if (typeof structuredClone === "function") return structuredClone(obj);
        } catch (e) {}
        return JSON.parse(JSON.stringify(obj));
      }

      function stableStringify(value) {
        const seen = new WeakSet();
        const helper = (v) => {
          if (v === null || typeof v !== "object") return v;
          if (seen.has(v)) return "[Circular]";
          seen.add(v);
          if (Array.isArray(v)) return v.map(helper);
          const keys = Object.keys(v).sort();
          const out = {};
          keys.forEach((k) => (out[k] = helper(v[k])));
          return out;
        };
        return JSON.stringify(helper(value));
      }

      function normalizeCpfTo11(raw) {
        const digits = String(raw || "").replace(/\D+/g, "");
        if (!digits) return "";
        return digits.padStart(11, "0").slice(-11);
      }

      function itemKey(item) {
        // Chave estável para deduplicar rubricas, preservando conteúdo
        return stableStringify(item);
      }

      function mergeArrayUnique(targetArr, sourceArr, keyFn) {
        if (!Array.isArray(sourceArr) || !sourceArr.length) return 0;
        if (!Array.isArray(targetArr)) targetArr = [];
        const existing = new Set(targetArr.map(keyFn));
        let added = 0;
        sourceArr.forEach((x) => {
          const k = keyFn(x);
          if (!existing.has(k)) {
            targetArr.push(x);
            existing.add(k);
            added++;
          }
        });
        return added;
      }

      function mergeRemuInto(baseRemu, otherRemu) {
        // Mescla itens de rubrica (e outros blocos existentes) por união
        let addedItens = 0;

        // Itens
        if (!Array.isArray(baseRemu.s1202RemuTrabRPPSItens)) baseRemu.s1202RemuTrabRPPSItens = [];
        addedItens += mergeArrayUnique(
          baseRemu.s1202RemuTrabRPPSItens,
          otherRemu.s1202RemuTrabRPPSItens || [],
          itemKey
        );

        // InfoRRA (se existir)
        if (otherRemu.s1202RemuTrabRPPSInfoRRA) {
          if (!Array.isArray(baseRemu.s1202RemuTrabRPPSInfoRRA)) baseRemu.s1202RemuTrabRPPSInfoRRA = [];
          mergeArrayUnique(
            baseRemu.s1202RemuTrabRPPSInfoRRA,
            otherRemu.s1202RemuTrabRPPSInfoRRA || [],
            stableStringify
          );
        }

        // Outros campos desconhecidos do remu: preserva base (não sobrescreve)
        return { addedItens };
      }

      function mergePagtoInto(basePagto, otherPagto) {
        // Mescla árvore Per > Estab > Remu > Itens por match de chaves de negócio
        // Per: perRef + anoRef + tpRegistro
        let addedItens = 0;

        const basePer = Array.isArray(basePagto.s1202RemuTrabRPPSPer) ? basePagto.s1202RemuTrabRPPSPer : [];
        if (!Array.isArray(basePagto.s1202RemuTrabRPPSPer)) basePagto.s1202RemuTrabRPPSPer = basePer;

        const otherPer = Array.isArray(otherPagto.s1202RemuTrabRPPSPer) ? otherPagto.s1202RemuTrabRPPSPer : [];

        const perKey = (p) => `${p.anoRef || ""}|${p.perRef || ""}|${p.tpRegistro || ""}`;

        const basePerMap = new Map(basePer.map((p) => [perKey(p), p]));

        otherPer.forEach((p) => {
          const k = perKey(p);
          if (!basePerMap.has(k)) {
            basePer.push(p);
            basePerMap.set(k, p);
            return;
          }

          const bp = basePerMap.get(k);
          if (!Array.isArray(bp.s1202RemuTrabRPPSEstab)) bp.s1202RemuTrabRPPSEstab = [];
          const beArr = bp.s1202RemuTrabRPPSEstab;

          const otherEst = Array.isArray(p.s1202RemuTrabRPPSEstab) ? p.s1202RemuTrabRPPSEstab : [];

          const estabKey = (e) => {
            const nr = (e.nrInsc && (e.nrInsc.nrInsc || e.nrInsc)) || "";
            const tp = (e.nrInsc && e.nrInsc.tpInsc && e.nrInsc.tpInsc.tipo) || (e.tpInsc && e.tpInsc.tipo) || "";
            const ini = (e.nrInsc && e.nrInsc.iniValid) || e.iniValid || "";
            return `${tp}|${nr}|${ini}`;
          };

          const beMap = new Map(beArr.map((e) => [estabKey(e), e]));

          otherEst.forEach((e) => {
            const ek = estabKey(e);
            if (!beMap.has(ek)) {
              beArr.push(e);
              beMap.set(ek, e);
              return;
            }

            const be = beMap.get(ek);
            if (!Array.isArray(be.s1202RemuTrabRPPSRemu)) be.s1202RemuTrabRPPSRemu = [];
            const brArr = be.s1202RemuTrabRPPSRemu;

            const otherRemu = Array.isArray(e.s1202RemuTrabRPPSRemu) ? e.s1202RemuTrabRPPSRemu : [];

            const remuKey = (r) => {
              const mat = (r.contrato && r.contrato.matricula) || "";
              const cat = (r.codCateg && r.codCateg.categoria) || "";
              return `${mat}|${cat}`;
            };

            const brMap = new Map(brArr.map((r) => [remuKey(r), r]));

            otherRemu.forEach((r) => {
              const rk = remuKey(r);
              if (!brMap.has(rk)) {
                brArr.push(r);
                brMap.set(rk, r);
                // Conta itens desse remu inteiro como "adicionados"
                const cnt = Array.isArray(r.s1202RemuTrabRPPSItens) ? r.s1202RemuTrabRPPSItens.length : 0;
                addedItens += cnt;
                return;
              }

              const br = brMap.get(rk);
              const res = mergeRemuInto(br, r);
              addedItens += res.addedItens || 0;
            });
          });
        });

        // IdeAdv: união
        if (otherPagto.s1202RemuTrabRPPSIdeAdv) {
          if (!Array.isArray(basePagto.s1202RemuTrabRPPSIdeAdv)) basePagto.s1202RemuTrabRPPSIdeAdv = [];
          mergeArrayUnique(
            basePagto.s1202RemuTrabRPPSIdeAdv,
            otherPagto.s1202RemuTrabRPPSIdeAdv || [],
            stableStringify
          );
        }

        // Campos escalares: preserva base (não sobrescreve)
        return { addedItens };
      }

      function canonicalizePagtoForSignature(pagto) {
        // Remove ideDmDev e normaliza arrays para comparar "equivalentes"
        const clone = deepClone(pagto || {});
        delete clone.ideDmDev;

        // Ordenações para reduzir falsos negativos
        const sortBy = (arr, fn) => Array.isArray(arr) ? arr.sort((a,b)=> (fn(a)>fn(b)?1:fn(a)<fn(b)?-1:0)) : arr;

        if (Array.isArray(clone.s1202RemuTrabRPPSIdeAdv)) {
          sortBy(clone.s1202RemuTrabRPPSIdeAdv, stableStringify);
        }

        if (Array.isArray(clone.s1202RemuTrabRPPSPer)) {
          sortBy(clone.s1202RemuTrabRPPSPer, (p)=>`${p.anoRef||""}|${p.perRef||""}|${p.tpRegistro||""}`);
          clone.s1202RemuTrabRPPSPer.forEach((p) => {
            if (Array.isArray(p.s1202RemuTrabRPPSEstab)) {
              sortBy(p.s1202RemuTrabRPPSEstab, (e)=>{
                const nr=(e.nrInsc && (e.nrInsc.nrInsc||e.nrInsc))||"";
                const tp=(e.nrInsc && e.nrInsc.tpInsc && e.nrInsc.tpInsc.tipo)||"";
                const ini=(e.nrInsc && e.nrInsc.iniValid)||"";
                return `${tp}|${nr}|${ini}`;
              });
              p.s1202RemuTrabRPPSEstab.forEach((e) => {
                if (Array.isArray(e.s1202RemuTrabRPPSRemu)) {
                  sortBy(e.s1202RemuTrabRPPSRemu, (r)=>`${(r.contrato&&r.contrato.matricula)||""}|${(r.codCateg&&r.codCateg.categoria)||""}`);
                  e.s1202RemuTrabRPPSRemu.forEach((r) => {
                    if (Array.isArray(r.s1202RemuTrabRPPSItens)) {
                      sortBy(r.s1202RemuTrabRPPSItens, (it)=>`${(it.codRubr&&it.codRubr.codRubr)||""}|${(it.codRubr&&it.codRubr.iniValid)||""}|${it.ideTabRubr||""}|${it.indApurIR||""}|${it.vrRubr||""}|${it.qtdRubr||""}|${it.fatorRubr||""}`);
                      r.s1202RemuTrabRPPSItens.forEach((it) => {
                        if (Array.isArray(it.s1202RemuTrabRPPSDescFolha)) {
                          sortBy(it.s1202RemuTrabRPPSDescFolha, stableStringify);
                        }
                      });
                    }
                    if (Array.isArray(r.s1202RemuTrabRPPSInfoRRA)) {
                      sortBy(r.s1202RemuTrabRPPSInfoRRA, stableStringify);
                    }
                  });
                }
              });
            }
          });
        }

        return stableStringify(clone);
      }

      function runMergeOnEventos(eventos, options) {
        const alsoEquivalent = !!(options && options.alsoEquivalent);

        let totalPagtoBefore = 0;
        let totalPagtoAfter = 0;
        let mergedBySameIde = 0;
        let removedEquivalent = 0;
        let totalItensAdded = 0;
        const details = [];

        (eventos || []).forEach((evt) => {
          const cpf = normalizeCpfTo11(evt?.trabalhador?.cpfTrab || "");
          const pagtos = Array.isArray(evt.s1202RemuTrabRPPSPagtos) ? evt.s1202RemuTrabRPPSPagtos : [];
          totalPagtoBefore += pagtos.length;

          if (pagtos.length <= 1) {
            totalPagtoAfter += pagtos.length;
            return;
          }

          // Passo 1: mesclar por ideDmDev idêntico (união de rubricas)
          const firstIndexByIde = new Map();
          const mergedObjectsByIde = new Map();
          const skip = new Set();

          for (let i = 0; i < pagtos.length; i++) {
            const ide = (pagtos[i] && pagtos[i].ideDmDev) || "";
            if (!ide) continue;

            if (!firstIndexByIde.has(ide)) {
              firstIndexByIde.set(ide, i);
              mergedObjectsByIde.set(ide, pagtos[i]);
              continue;
            }

            const base = mergedObjectsByIde.get(ide);
            const other = pagtos[i];
            const res = mergePagtoInto(base, other);
            totalItensAdded += res.addedItens || 0;
            mergedBySameIde++;
            skip.add(i);
          }

          let mergedList = [];
          for (let i = 0; i < pagtos.length; i++) {
            if (skip.has(i)) continue;
            mergedList.push(pagtos[i]);
          }

          // Passo 2: remover duplicados equivalentes (difere só ideDmDev)
          if (alsoEquivalent && mergedList.length > 1) {
            const sigMap = new Map(); // signature -> index kept
            const keep = [];
            for (let i = 0; i < mergedList.length; i++) {
              const p = mergedList[i];
              const sig = canonicalizePagtoForSignature(p);
              if (!sigMap.has(sig)) {
                sigMap.set(sig, keep.length);
                keep.push(p);
              } else {
                // duplicado: não perde rubrica porque assinatura é idêntica (exceto ideDmDev)
                removedEquivalent++;
                details.push(`CPF ${cpf || "(sem CPF)"}: removido pagamento duplicado equivalente (ideDmDev="${p.ideDmDev || ""}")`);
              }
            }
            mergedList = keep;
          }

          if (mergedList.length !== pagtos.length) {
            evt.s1202RemuTrabRPPSPagtos = mergedList;
            details.push(`CPF ${cpf || "(sem CPF)"}: pagamentos ${pagtos.length} → ${mergedList.length}`);
          }

          totalPagtoAfter += (evt.s1202RemuTrabRPPSPagtos || []).length;
        });

        return {
          totalPagtoBefore,
          totalPagtoAfter,
          mergedBySameIde,
          removedEquivalent,
          totalItensAdded,
          details
        };
      }

      function renderPreview(simResult) {
        const lines = [];
        lines.push(`Pagamentos (total): ${simResult.totalPagtoBefore} → ${simResult.totalPagtoAfter}`);
        lines.push(`Mesclagens por ideDmDev idêntico: ${simResult.mergedBySameIde}`);
        lines.push(`Rubricas adicionadas por união: ${simResult.totalItensAdded}`);
        lines.push(`Duplicados equivalentes removidos: ${simResult.removedEquivalent}`);
        lines.push("");
        lines.push("Detalhes (amostra):");
        const max = 50;
        (simResult.details || []).slice(0, max).forEach((d) => lines.push(`- ${d}`));
        if ((simResult.details || []).length > max) {
          lines.push(`... (${(simResult.details || []).length - max} linhas adicionais omitidas)`);
        }
        previewEl.value = lines.join("\n");

        if ((simResult.mergedBySameIde || 0) === 0 && (simResult.removedEquivalent || 0) === 0) {
          alertEl.style.display = "block";
          alertEl.className = "alert alert-success";
          alertEl.textContent = "Nenhuma mesclagem necessária. Não foram encontrados pagamentos duplicados por ideDmDev nem equivalentes.";
        } else {
          alertEl.style.display = "block";
          alertEl.className = "alert alert-info";
          alertEl.textContent = "Prévia calculada. Revise o resumo e aplique para consolidar os pagamentos.";
        }
      }

      function computePreview() {
        if (!window.esocialData) {
          previewEl.value = "Nenhum arquivo JSON carregado.";
          alertEl.style.display = "block";
          alertEl.className = "alert alert-warning";
          alertEl.textContent = "Carregue um JSON antes de usar esta ferramenta.";
          return null;
        }
        const eventos = getEventos();
        const simEventos = deepClone(eventos);
        const sim = runMergeOnEventos(simEventos, { alsoEquivalent: alsoEqEl.checked });
        renderPreview(sim);
        return sim;
      }

      // Ao abrir o modal, calcula a prévia
      $(modalId).on("shown.bs.modal", function () {
        computePreview();
        previewEl.scrollTop = 0;
      });

      refreshBtn.addEventListener("click", function () {
        computePreview();
      });

      applyBtn.addEventListener("click", function () {
        if (!window.esocialData) {
          alert("Nenhum arquivo JSON carregado.");
          return;
        }
        const eventos = getEventos();
        const result = runMergeOnEventos(eventos, { alsoEquivalent: alsoEqEl.checked });

        // Aplica no mesmo nó (apenas pagtos alterados são substituídos)
        window.esocialData.s1202RemuTrabRPPSGroup.s1202RemuTrabRPPS = eventos;

        renderEventos();
        refreshJsonLoadInfo();
        $(modalId).modal("hide");

        alert(
          `Mesclagem concluída.\n` +
          `Pagamentos: ${result.totalPagtoBefore} → ${result.totalPagtoAfter}\n` +
          `Mesclagens por ideDmDev: ${result.mergedBySameIde}\n` +
          `Rubricas adicionadas: ${result.totalItensAdded}\n` +
          `Duplicados equivalentes removidos: ${result.removedEquivalent}`
        );
      });
    })();
</script>
</body>
</html>
